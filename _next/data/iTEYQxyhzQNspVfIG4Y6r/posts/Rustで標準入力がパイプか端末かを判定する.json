{"pageProps":{"post":{"title":"Rustで標準入力がパイプか端末かを判定する","published":"2022/10/07","tags":[],"content":"\nパイプから標準入力に渡した場合はそのまま処理し、端末から入力する場合はプロンプトを表示したくて調べた。\n\nシステムコールの [ISATTY](https://linuxjm.osdn.jp/html/LDP_man-pages/man3/isatty.3.html) を使えばよい。\n[libc](https://docs.rs/libc/latest/libc/) か [nix](https://docs.rs/nix/latest/nix/) ならシテムコールを叩ける。\n今回は Rust で使いやすいようにラップしてくれている `nix` を使う。\n\n```rust\nfn main() -> Result<(), Box<dyn Error>> {\n    let mut buffer = String::new();\n    if isatty(STDIN_FILENO)? {\n        print!(\"term> \");\n        stdout().flush().unwrap();\n    }\n\n    let stdin = io::stdin();\n    stdin.read_line(&mut buffer)?;\n    print!(\"{}\", buffer);\n    Ok(())\n}\n```\n\nこれでパイプから渡した際には `echo` と同じように渡した文字列がそのまま印字される。\n直接起動した際は `term> ` と印字され、入力して改行すると入力した文字が表示される。\n","slug":"Rustで標準入力がパイプか端末かを判定する"},"content":"<p>パイプから標準入力に渡した場合はそのまま処理し、端末から入力する場合はプロンプトを表示したくて調べた。</p>\n<p>システムコールの <a href=\"https://linuxjm.osdn.jp/html/LDP_man-pages/man3/isatty.3.html\">ISATTY</a> を使えばよい。<br>\n<a href=\"https://docs.rs/libc/latest/libc/\">libc</a> か <a href=\"https://docs.rs/nix/latest/nix/\">nix</a> ならシテムコールを叩ける。<br>\n今回は Rust で使いやすいようにラップしてくれている <code>nix</code> を使う。</p>\n<pre class=\"language-rust\"><code class=\"language-rust code-highlight\"><span class=\"code-line\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&#x3C;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token operator\">&#x3C;</span><span class=\"token keyword\">dyn</span> <span class=\"token class-name\">Error</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line\">    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">    <span class=\"token keyword\">if</span> <span class=\"token function\">isatty</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STDIN_FILENO</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line\">        <span class=\"token macro property\">print!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"term> \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">        <span class=\"token function\">stdout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">    <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line\">\n</span><span class=\"code-line\">    <span class=\"token keyword\">let</span> stdin <span class=\"token operator\">=</span> <span class=\"token namespace\">io<span class=\"token punctuation\">::</span></span><span class=\"token function\">stdin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">    stdin<span class=\"token punctuation\">.</span><span class=\"token function\">read_line</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&#x26;</span><span class=\"token keyword\">mut</span> buffer<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">    <span class=\"token macro property\">print!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line\">    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span><span class=\"code-line\"><span class=\"token punctuation\">}</span>\n</span></code></pre>\n<p>これでパイプから渡した際には <code>echo</code> と同じように渡した文字列がそのまま印字される。<br>\n直接起動した際は <code>term> </code> と印字され、入力して改行すると入力した文字が表示される。</p>"},"__N_SSG":true}