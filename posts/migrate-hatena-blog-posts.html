<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>はてなブログの記事を Next.js 製ブログにインポート | (wat-aro)</title><meta name="title" content="はてなブログの記事を Next.js 製ブログにインポート | (wat-aro)"/><meta name="description" content="[旧ブログ](https://wat-aro.hatenablog.com/) の記事の移行が終わりました。Rust のパーサコンビネータ [nom](https://github.com/Geal/nom) の使いかたに慣れるため [JSON parser](https://github.com/wat-aro/ws"/><meta property="og:locale" content="ja_jp"/><meta property="og:type" content="article"/><meta property="og:site_name" content="(wat-aro)"/><meta property="og:title" content="はてなブログの記事を Next.js 製ブログにインポート | (wat-aro)"/><meta property="og:image" content="https://wat-aro.dev/og-images/migrate-hatena-blog-posts.png"/><meta property="og:url" content="https://wat-aro.dev/posts/migrate-hatena-blog-posts"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@wat_aro"/><meta name="twitter:creator" content="@wat_aro"/><meta name="twitter:title" content="はてなブログの記事を Next.js 製ブログにインポート | (wat-aro)"/><meta name="twitter:description" content="[旧ブログ](https://wat-aro.hatenablog.com/) の記事の移行が終わりました。Rust のパーサコンビネータ [nom](https://github.com/Geal/nom) の使いかたに慣れるため [JSON parser](https://github.com/wat-aro/ws"/><meta name="twitter:image" content="https://wat-aro.dev/og-images/migrate-hatena-blog-posts.png"/><meta name="next-head-count" content="17"/><link rel="icon" href="/images/favicon.ico"/><link rel="preload" href="/_next/static/css/02ced8e6983f7546.css" as="style"/><link rel="stylesheet" href="/_next/static/css/02ced8e6983f7546.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d3eeee857401101e.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-0e1c4012a86ba0a9.js" defer=""></script><script src="/_next/static/OVo4Nr9ylvg1ic4KtaFag/_buildManifest.js" defer=""></script><script src="/_next/static/OVo4Nr9ylvg1ic4KtaFag/_ssgManifest.js" defer=""></script><script src="/_next/static/OVo4Nr9ylvg1ic4KtaFag/_middlewareManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MW6D56L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><div class="py-0 md:px-8 min-h-screen flex flex-col items-center"><div class="top-0 bg-white w-full h-16 flex flex-row justify-between items-center px-4 border-b-2"><a href="/"><div class="flex items-center font-midium text-3xl h-full font-bold gap-4"><img class="rounded-full" src="/images/profile.jpg" width="48" height="48" alt="profile image"/>(wat-aro)<!-- --></div></a><ul class="flex gap-3 h-full"><li class="h-full  flex flex-col justify-end border-black pb-4"><a href="/about">About</a></li><li class="h-full  flex flex-col justify-end border-black pb-3 border-b-4"><a href="/posts/pages/1">Blog</a></li></ul></div><div class="flex md:justify-center justify-between w-full"><div class="flex flex-col sm:max-w-sm md:max-w-4xl w-full py-4 px-4"><article class="flex max-w-4xl w-full"><div class="py-4 w-full"><div class="mr-2 text-xs font-bold">2022/06/15</div><h1 class="font-bold text-3xl text-black">はてなブログの記事を Next.js 製ブログにインポート</h1><nav class="flex mt-2 mb-2 items-start text-gray-500 text-xs"><div class="flex flex-nowrap max-w-full overflow-x-auto"><p class="mr-1 rounded-full px-2 py-1 border leading-none">Rust</p><p class="mr-1 rounded-full px-2 py-1 border leading-none">Next.js</p><p class="mr-1 rounded-full px-2 py-1 border leading-none">TypeScript</p></div></nav><div class="znc"><p><a href="https://wat-aro.hatenablog.com/">旧ブログ</a> の記事の移行が終わりました。<br>
Rust のパーサコンビネータ <a href="https://github.com/Geal/nom">nom</a> の使いかたに慣れるため <a href="https://github.com/wat-aro/wson">JSON parser</a> を作ったりと寄り道が激しかったです。</p>
<p>はてなブログから記事をエクスポートすると <a href="https://www.sixapart.jp/movabletype/">Movable Type</a> で書かれた txt ファイルをダウンロードできます。<br>
これを変換して markdown で書いているこのサイトでインポートできるようにしたい。<br>
<a href="https://www.sixapart.jp/movabletype/manual/3.3/f_import_format/">Movable Type のフォーマット</a> にちゃんと対応するのは大変なので必要なところだけ対応した。</p>
<h2 id="movable_type_to_markdown">movable_type_to_markdown</h2>
<p>作った移行ツールがこちら <a href="https://github.com/wat-aro/movable_type_to_markdown">https://github.com/wat-aro/movable_type_to_markdown</a><br>
使ったことがなかったので <a href="https://github.com/clap-rs/clap">clap</a> や <a href="https://github.com/dtolnay/anyhow">anyhow</a> を使ってみた。<br>
to_markdown といいつつ、実際は Movable Type ファイルに入っていた html のまま。<br>
最初は html からマークダウンにしようかと考えていたけれどコードブロックの <code>pre</code> タグがめんどくさすぎて断念。</p>
<pre class="language-shell"><code class="language-shell code-highlight"><span class="code-line">cargo run MOVABLE_TYPE_FILE OUTPUT_DIRECTORY
</span></code></pre>
<p>で OUTPUT_DIRECTORY に変換した markdown ファイルを出力できます。<br>
作りはシンプルに パースして記事用のオブジェクトを作成してファイル作成。</p>
<h2 id="はまりどころ-1">はまりどころ 1</h2>
<p>Movable Type の複数行フィールド・セクションは <code>-----\n</code> によって区切られている。<br>
本文で <code>-----------\n</code> などが使われている箇所があったためパースできなくなってしまった。<br>
セパレータは行頭から開始される場合に限るため <code>\n-----\n</code> で判定することでなんとかなった</p>
<h2 id="はまりどころ-2">はまりどころ 2</h2>
<p>コードブロック以外はそのままの html でそれなりに表示されているのでそれでよしとした。<br>
ただコードブロックはいかんともしがたく。<br>
これはこちらのサイト側で対応。<br>
はてなブログのコードブロックの <code>pre</code> タグ直下に <code>code</code> タグを入れて children をラップすると、ハイライトされないが改行はきちんと反映されることがわかった。<br>
ただし、markdown で書いたコードブロックを使っているため、<code>pre</code> タグのクラス名に <code>code</code> が含まれている場合にはてなブログのコードブロックだと判定するようにした。<br>
このサイトは <code>unified</code> を使ってマークダウンから html に変換している。<br>
以下の plugin を追加することでコードブロックを表示できるようにした。</p>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">const</span> rehypeHatenaCodeBlock<span class="token operator">:</span> <span class="token function-variable function">Plugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token punctuation">(</span>tree<span class="token punctuation">,</span> file<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token function">visit</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">'element'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="code-line">        node<span class="token punctuation">.</span>tagName <span class="token operator">==</span> <span class="token string">'pre'</span> <span class="token operator">&#x26;&#x26;</span>
</span><span class="code-line">        node<span class="token punctuation">.</span>properties<span class="token operator">?.</span>className <span class="token operator">&#x26;&#x26;</span>
</span><span class="code-line">        <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>className<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span>
</span><span class="code-line">        node<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">const</span> children <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
</span><span class="code-line">        <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">          type<span class="token operator">:</span> <span class="token string">'element'</span><span class="token punctuation">,</span>
</span><span class="code-line">          tagName<span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
</span><span class="code-line">          properties<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">          children<span class="token operator">:</span> children<span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token punctuation">}</span> <span class="token keyword">as</span> ElementContent<span class="token punctuation">;</span>
</span><span class="code-line">        node<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre>
<h3 id="今後の展望">今後の展望</h3>
<p>今は全件表示されているため、次はページネーションを導入するぞい。</p></div></div></article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"はてなブログの記事を Next.js 製ブログにインポート","published":"2022/06/15","tags":["Rust","Next.js","TypeScript"],"content":"\u003cp\u003e\u003ca href=\"https://wat-aro.hatenablog.com/\"\u003e旧ブログ\u003c/a\u003e の記事の移行が終わりました。\u003cbr\u003e\nRust のパーサコンビネータ \u003ca href=\"https://github.com/Geal/nom\"\u003enom\u003c/a\u003e の使いかたに慣れるため \u003ca href=\"https://github.com/wat-aro/wson\"\u003eJSON parser\u003c/a\u003e を作ったりと寄り道が激しかったです。\u003c/p\u003e\n\u003cp\u003eはてなブログから記事をエクスポートすると \u003ca href=\"https://www.sixapart.jp/movabletype/\"\u003eMovable Type\u003c/a\u003e で書かれた txt ファイルをダウンロードできます。\u003cbr\u003e\nこれを変換して markdown で書いているこのサイトでインポートできるようにしたい。\u003cbr\u003e\n\u003ca href=\"https://www.sixapart.jp/movabletype/manual/3.3/f_import_format/\"\u003eMovable Type のフォーマット\u003c/a\u003e にちゃんと対応するのは大変なので必要なところだけ対応した。\u003c/p\u003e\n\u003ch2 id=\"movable_type_to_markdown\"\u003emovable_type_to_markdown\u003c/h2\u003e\n\u003cp\u003e作った移行ツールがこちら \u003ca href=\"https://github.com/wat-aro/movable_type_to_markdown\"\u003ehttps://github.com/wat-aro/movable_type_to_markdown\u003c/a\u003e\u003cbr\u003e\n使ったことがなかったので \u003ca href=\"https://github.com/clap-rs/clap\"\u003eclap\u003c/a\u003e や \u003ca href=\"https://github.com/dtolnay/anyhow\"\u003eanyhow\u003c/a\u003e を使ってみた。\u003cbr\u003e\nto_markdown といいつつ、実際は Movable Type ファイルに入っていた html のまま。\u003cbr\u003e\n最初は html からマークダウンにしようかと考えていたけれどコードブロックの \u003ccode\u003epre\u003c/code\u003e タグがめんどくさすぎて断念。\u003c/p\u003e\n\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell code-highlight\"\u003e\u003cspan class=\"code-line\"\u003ecargo run MOVABLE_TYPE_FILE OUTPUT_DIRECTORY\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eで OUTPUT_DIRECTORY に変換した markdown ファイルを出力できます。\u003cbr\u003e\n作りはシンプルに パースして記事用のオブジェクトを作成してファイル作成。\u003c/p\u003e\n\u003ch2 id=\"はまりどころ-1\"\u003eはまりどころ 1\u003c/h2\u003e\n\u003cp\u003eMovable Type の複数行フィールド・セクションは \u003ccode\u003e-----\\n\u003c/code\u003e によって区切られている。\u003cbr\u003e\n本文で \u003ccode\u003e-----------\\n\u003c/code\u003e などが使われている箇所があったためパースできなくなってしまった。\u003cbr\u003e\nセパレータは行頭から開始される場合に限るため \u003ccode\u003e\\n-----\\n\u003c/code\u003e で判定することでなんとかなった\u003c/p\u003e\n\u003ch2 id=\"はまりどころ-2\"\u003eはまりどころ 2\u003c/h2\u003e\n\u003cp\u003eコードブロック以外はそのままの html でそれなりに表示されているのでそれでよしとした。\u003cbr\u003e\nただコードブロックはいかんともしがたく。\u003cbr\u003e\nこれはこちらのサイト側で対応。\u003cbr\u003e\nはてなブログのコードブロックの \u003ccode\u003epre\u003c/code\u003e タグ直下に \u003ccode\u003ecode\u003c/code\u003e タグを入れて children をラップすると、ハイライトされないが改行はきちんと反映されることがわかった。\u003cbr\u003e\nただし、markdown で書いたコードブロックを使っているため、\u003ccode\u003epre\u003c/code\u003e タグのクラス名に \u003ccode\u003ecode\u003c/code\u003e が含まれている場合にはてなブログのコードブロックだと判定するようにした。\u003cbr\u003e\nこのサイトは \u003ccode\u003eunified\u003c/code\u003e を使ってマークダウンから html に変換している。\u003cbr\u003e\n以下の plugin を追加することでコードブロックを表示できるようにした。\u003c/p\u003e\n\u003cpre class=\"language-ts\"\u003e\u003ccode class=\"language-ts code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e rehypeHatenaCodeBlock\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003ePlugin\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etree\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e file\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token function\"\u003evisit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etree\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'element'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enode\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Element\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        node\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etagName \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'pre'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        node\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eproperties\u003cspan class=\"token operator\"\u003e?.\u003c/span\u003eclassName \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"token builtin\"\u003eArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eproperties\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eclassName\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        node\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eproperties\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eclassName\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincludes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'code'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e children \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e node\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e code \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          type\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'element'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          tagName\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'code'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          properties\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          children\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e children\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e ElementContent\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        node\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ecode\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"今後の展望\"\u003e今後の展望\u003c/h3\u003e\n\u003cp\u003e今は全件表示されているため、次はページネーションを導入するぞい。\u003c/p\u003e","slug":"migrate-hatena-blog-posts","rawContent":"\n[旧ブログ](https://wat-aro.hatenablog.com/) の記事の移行が終わりました。\nRust のパーサコンビネータ [nom](https://github.com/Geal/nom) の使いかたに慣れるため [JSON parser](https://github.com/wat-aro/wson) を作ったりと寄り道が激しかったです。\n\nはてなブログから記事をエクスポートすると [Movable Type](https://www.sixapart.jp/movabletype/) で書かれた txt ファイルをダウンロードできます。\nこれを変換して markdown で書いているこのサイトでインポートできるようにしたい。\n[Movable Type のフォーマット](https://www.sixapart.jp/movabletype/manual/3.3/f_import_format/) にちゃんと対応するのは大変なので必要なところだけ対応した。\n\n## movable_type_to_markdown\n\n作った移行ツールがこちら https://github.com/wat-aro/movable_type_to_markdown\n使ったことがなかったので [clap](https://github.com/clap-rs/clap) や [anyhow](https://github.com/dtolnay/anyhow) を使ってみた。\nto_markdown といいつつ、実際は Movable Type ファイルに入っていた html のまま。\n最初は html からマークダウンにしようかと考えていたけれどコードブロックの `pre` タグがめんどくさすぎて断念。\n\n```shell\ncargo run MOVABLE_TYPE_FILE OUTPUT_DIRECTORY\n```\n\nで OUTPUT_DIRECTORY に変換した markdown ファイルを出力できます。\n作りはシンプルに パースして記事用のオブジェクトを作成してファイル作成。\n\n## はまりどころ 1\n\nMovable Type の複数行フィールド・セクションは `-----\\n` によって区切られている。\n本文で `-----------\\n` などが使われている箇所があったためパースできなくなってしまった。\nセパレータは行頭から開始される場合に限るため `\\n-----\\n` で判定することでなんとかなった\n\n## はまりどころ 2\n\nコードブロック以外はそのままの html でそれなりに表示されているのでそれでよしとした。\nただコードブロックはいかんともしがたく。\nこれはこちらのサイト側で対応。\nはてなブログのコードブロックの `pre` タグ直下に `code` タグを入れて children をラップすると、ハイライトされないが改行はきちんと反映されることがわかった。\nただし、markdown で書いたコードブロックを使っているため、`pre` タグのクラス名に `code` が含まれている場合にはてなブログのコードブロックだと判定するようにした。\nこのサイトは `unified` を使ってマークダウンから html に変換している。\n以下の plugin を追加することでコードブロックを表示できるようにした。\n\n```ts\nexport const rehypeHatenaCodeBlock: Plugin = () =\u003e {\n  return (tree, file) =\u003e {\n    visit(tree, 'element', (node: Element) =\u003e {\n      if (\n        node.tagName == 'pre' \u0026\u0026\n        node.properties?.className \u0026\u0026\n        Array.isArray(node.properties.className) \u0026\u0026\n        node.properties.className.includes('code')\n      ) {\n        const children = node.children;\n        const code = {\n          type: 'element',\n          tagName: 'code',\n          properties: {},\n          children: children,\n        } as ElementContent;\n        node.children = [code];\n      }\n      return true;\n    });\n  };\n};\n```\n\n### 今後の展望\n\n今は全件表示されているため、次はページネーションを導入するぞい。\n"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"migrate-hatena-blog-posts"},"buildId":"OVo4Nr9ylvg1ic4KtaFag","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>