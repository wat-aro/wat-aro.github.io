<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>SICP 4.4.4 質問システムの実装 | (wat-aro)</title><meta name="title" content="SICP 4.4.4 質問システムの実装 | (wat-aro)"/><meta name="description" content="&lt;p&gt;なかなか処理の流れがわからなかったのでコメントを多めにつけてみた．&lt;/p&gt;&lt;pre class=&quot;code lang-scheme&quot; data-lang=&quot;scheme&quot; data-unlink&gt;&lt;span class=&quot;synComment&quot;&gt;;; 駆動ループ&lt;/span&gt;&lt;span class=&quot;synSpe"/><meta property="og:locale" content="ja_jp"/><meta property="og:type" content="article"/><meta property="og:site_name" content="(wat-aro)"/><meta property="og:title" content="SICP 4.4.4 質問システムの実装 | (wat-aro)"/><meta property="og:image" content="https://wat-aro.dev/og-images/SICP 4.4.4 質問システムの実装.png"/><meta property="og:url" content="https://wat-aro.dev/posts/SICP%204.4.4%20%E8%B3%AA%E5%95%8F%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E5%AE%9F%E8%A3%85"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@wat_aro"/><meta name="twitter:creator" content="@wat_aro"/><meta name="twitter:title" content="SICP 4.4.4 質問システムの実装 | (wat-aro)"/><meta name="twitter:description" content="&lt;p&gt;なかなか処理の流れがわからなかったのでコメントを多めにつけてみた．&lt;/p&gt;&lt;pre class=&quot;code lang-scheme&quot; data-lang=&quot;scheme&quot; data-unlink&gt;&lt;span class=&quot;synComment&quot;&gt;;; 駆動ループ&lt;/span&gt;&lt;span class=&quot;synSpe"/><meta name="twitter:image" content="https://wat-aro.dev/og-images/SICP 4.4.4 質問システムの実装.png"/><meta name="next-head-count" content="17"/><link rel="icon" href="/images/favicon.ico"/><link rel="preload" href="/_next/static/css/efce62830f77489e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/efce62830f77489e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d19aa426007499ce.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-0e1c4012a86ba0a9.js" defer=""></script><script src="/_next/static/wu5pd2semhKOEcEl6RoK2/_buildManifest.js" defer=""></script><script src="/_next/static/wu5pd2semhKOEcEl6RoK2/_ssgManifest.js" defer=""></script><script src="/_next/static/wu5pd2semhKOEcEl6RoK2/_middlewareManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MW6D56L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><div class="py-0 md:px-8 min-h-screen flex flex-col items-center"><div class="top-0 bg-white w-full h-16 flex flex-row justify-between items-center px-4 border-b-2"><a href="/"><div class="flex items-center font-midium text-3xl h-full font-bold gap-4"><img class="rounded-full" src="/images/profile.jpg" width="48" height="48" alt="profile image"/>(wat-aro)<!-- --></div></a><ul class="flex gap-3 h-full"><li class="h-full  flex flex-col justify-end border-black pb-4"><a href="/about">About</a></li><li class="h-full  flex flex-col justify-end border-black pb-3 border-b-4"><a href="/posts">Blog</a></li></ul></div><div class="flex md:justify-center justify-between w-full"><div class="flex flex-col sm:max-w-sm md:max-w-4xl w-full py-4 px-4"><article class="flex max-w-4xl w-full"><div class="py-4 w-full"><div class="mr-2 text-xs font-bold">2016/01/21</div><h1 class="font-bold text-3xl text-black">SICP 4.4.4 質問システムの実装</h1><nav class="flex mt-2 mb-2 items-start text-gray-500 text-xs"><div class="flex flex-nowrap max-w-full overflow-x-auto"><p class="mr-1 rounded-full px-2 py-1 border leading-none">scheme</p><p class="mr-1 rounded-full px-2 py-1 border leading-none">SICP</p></div></nav><div class="znc"><p>なかなか処理の流れがわからなかったのでコメントを多めにつけてみた．</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink=""><code class="code-highlight"><span class="code-line"><span class="synComment">;; 駆動ループ</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> input-prompt <span class="synConstant">";;; Query input:"</span><span class="synSpecial">)</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> output-prompt <span class="synConstant">";;; Query result:"</span><span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>prompt-for-input <span class="synIdentifier">string</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">display</span> <span class="synIdentifier">string</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>query-driver-loop<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>prompt-for-input input-prompt<span class="synSpecial">)</span>       <span class="synComment">;最初の印字</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>q <span class="synSpecial">(</span>query-syntax-process <span class="synSpecial">(</span><span class="synIdentifier">read</span><span class="synSpecial">))))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span>assertion-to-be-added? q<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span>add-rule-or-assertion! <span class="synSpecial">(</span>add-assertion-body q<span class="synSpecial">))</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synIdentifier">display</span> <span class="synConstant">"Assertion added to data base."</span><span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span>query-driver-loop<span class="synSpecial">))</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">else</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synIdentifier">display</span> output-prompt<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span>display-stream
</span><span class="code-line">            <span class="synComment">;; このstream-mapで回答のストリームが作られる．</span>
</span><span class="code-line">            <span class="synSpecial">(</span>stream-map
</span><span class="code-line">             <span class="synComment">;; フレームを取り，変数を具体化したもともとの質問のコピーからなるストリームを作る</span>
</span><span class="code-line">             <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>frame<span class="synSpecial">)</span>
</span><span class="code-line">               <span class="synSpecial">(</span>instantiate q frame
</span><span class="code-line">                            <span class="synComment">;; unbound-handlerに渡す部分．</span>
</span><span class="code-line">                            <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>v f<span class="synSpecial">)</span>
</span><span class="code-line">                              <span class="synSpecial">(</span>contract-question-mark v<span class="synSpecial">))))</span>
</span><span class="code-line">             <span class="synComment">;; 質問を満たすフレームのストリーム</span>
</span><span class="code-line">             <span class="synSpecial">(</span>qeval q <span class="synSpecial">(</span>singleton-stream <span class="synSpecial">'()))))</span>
</span><span class="code-line">           <span class="synSpecial">(</span>query-driver-loop<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; qevalで作られたストリームのフレームをとqを取る．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>instantiate <span class="synIdentifier">exp</span> frame unbound-var-handler<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>copy <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span>var? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synComment">;; binding-in-frameで(? x)と対応した((? x) Aull DeWitt)のような形で取り出す．</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>binding <span class="synSpecial">(</span>binding-in-frame <span class="synIdentifier">exp</span> frame<span class="synSpecial">)))</span>
</span><span class="code-line">             <span class="synSpecial">(</span><span class="synStatement">if</span> binding
</span><span class="code-line">                 <span class="synComment">;; 取り出した((? x) Aull DeWitt)を(Aull DeWitt)にしてcopyに渡す．</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>copy <span class="synSpecial">(</span>binding-value binding<span class="synSpecial">))</span>
</span><span class="code-line">                 <span class="synComment">;; (? 5 x)を?x-5に変える</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>unbound-var-handler <span class="synIdentifier">exp</span> frame<span class="synSpecial">))))</span>
</span><span class="code-line">          <span class="synSpecial">((</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>copy <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synIdentifier">exp</span><span class="synSpecial">))</span> <span class="synSpecial">(</span>copy <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> <span class="synIdentifier">exp</span><span class="synSpecial">))))</span> <span class="synComment">;リストの形は維持したままcarとcdrをcopyする</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">  <span class="synSpecial">(</span>copy <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 評価機</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>qeval query frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>qproc <span class="synSpecial">(</span>get <span class="synSpecial">(</span>type query<span class="synSpecial">)</span> <span class="synSpecial">'</span>qeval<span class="synSpecial">)))</span> <span class="synComment">;queryがandかorから始まるかのチェック</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> qproc
</span><span class="code-line">        <span class="synSpecial">(</span>qproc <span class="synSpecial">(</span>contents query<span class="synSpecial">)</span> frame-stream<span class="synSpecial">)</span> <span class="synComment">;and, orで始まる場合</span>
</span><span class="code-line">        <span class="synSpecial">(</span>simple-query query frame-stream<span class="synSpecial">))))</span>  <span class="synComment">;それ以外</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 単純質問</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>simple-query query-pattern frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-flatmap
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>frame<span class="synSpecial">)</span>
</span><span class="code-line">     <span class="synComment">;; carがnullならcdrをforceするappend.find-assertionsでマッチするassertionがなければcdrへ．</span>
</span><span class="code-line">     <span class="synSpecial">(</span>stream-append-delayed
</span><span class="code-line">      <span class="synSpecial">(</span>find-assertions query-pattern frame<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">delay</span> <span class="synSpecial">(</span>apply-rules query-pattern frame<span class="synSpecial">))))</span>
</span><span class="code-line">   frame-stream<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 合成質問</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>conjoin conjuncts frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>empty-conjunction? conjuncts<span class="synSpecial">)</span>
</span><span class="code-line">      frame-stream
</span><span class="code-line">      <span class="synSpecial">(</span>conjoin <span class="synSpecial">(</span>rest-conjuncts conjuncts<span class="synSpecial">)</span>
</span><span class="code-line">               <span class="synSpecial">(</span>qeval <span class="synSpecial">(</span>first-conjunct conjuncts<span class="synSpecial">)</span>
</span><span class="code-line">                      frame-stream<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span>put <span class="synSpecial">'</span>and <span class="synSpecial">'</span>qeval conjoin<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>disjoin disjuncts frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>empty-disjunction? disjuncts<span class="synSpecial">)</span>
</span><span class="code-line">      the-empty-stream
</span><span class="code-line">      <span class="synSpecial">(</span>interleave-delayed
</span><span class="code-line">       <span class="synSpecial">(</span>qeval <span class="synSpecial">(</span>first-disjunct disjuncts<span class="synSpecial">)</span> frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">       <span class="synSpecial">(</span><span class="synStatement">delay</span> <span class="synSpecial">(</span>disjoin <span class="synSpecial">(</span>rest-disjuncts disjuncts<span class="synSpecial">)</span>
</span><span class="code-line">                       frame-stream<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span>put <span class="synSpecial">'</span>or <span class="synSpecial">'</span>qeval disjoin<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; フィルタ</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>negate operands frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-flatmap
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>frame<span class="synSpecial">)</span>
</span><span class="code-line">     <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>stream-null? <span class="synSpecial">(</span>qeval <span class="synSpecial">(</span>negated-query operands<span class="synSpecial">)</span>
</span><span class="code-line">                              <span class="synSpecial">(</span>singleton-stream frame<span class="synSpecial">)))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>singleton-stream frame<span class="synSpecial">)</span>
</span><span class="code-line">         the-empty-stream<span class="synSpecial">))</span>
</span><span class="code-line">   frame-stream<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span>put <span class="synSpecial">'</span>not <span class="synSpecial">'</span>qeval negate<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>lisp-value call frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-flatmap
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>frame<span class="synSpecial">)</span>
</span><span class="code-line">     <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>execute <span class="synSpecial">(</span>instantiate call
</span><span class="code-line">                               frame
</span><span class="code-line">                               <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>v f<span class="synSpecial">)</span>
</span><span class="code-line">                                 <span class="synSpecial">(</span>error <span class="synConstant">"Unknown pat var -- LISP-VALUE"</span> v<span class="synSpecial">))))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>singleton-stream frame<span class="synSpecial">)</span>
</span><span class="code-line">         the-empty-stream<span class="synSpecial">))</span>
</span><span class="code-line">   frame-stream<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span>put <span class="synSpecial">'</span>lisp-value <span class="synSpecial">'</span>qeval lisp-value<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>execute <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">apply</span> <span class="synSpecial">(</span><span class="synIdentifier">eval</span> <span class="synSpecial">(</span>predicate <span class="synIdentifier">exp</span><span class="synSpecial">)</span> user-initial-environment<span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>args <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>always-true ignore frame-stream<span class="synSpecial">)</span> frame-stream<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span>put <span class="synSpecial">'</span>always-true <span class="synSpecial">'</span>qeval always-true<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; パターンマッチにより表明を見つける</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>find-assertions pattern frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-flatmap <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>datum<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>check-an-assertion datum pattern frame<span class="synSpecial">))</span>
</span><span class="code-line">                  <span class="synComment">;; patternの先頭を見て，それにマッチするassertionをストリームで返す．</span>
</span><span class="code-line">                  <span class="synSpecial">(</span>fetch-assertions pattern frame<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>check-an-assertion assertion query-pat query-frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synComment">;;パターンマッチされ，failedになったフレームか，拡張されたフレームが入っている．</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>match-result
</span><span class="code-line">         <span class="synSpecial">(</span>pattern-match query-pat assertion query-frame<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> match-result <span class="synSpecial">'</span>failed<span class="synSpecial">)</span>
</span><span class="code-line">        the-empty-stream                <span class="synComment">;failedなら空のストリームを返す</span>
</span><span class="code-line">        <span class="synSpecial">(</span>singleton-stream match-result<span class="synSpecial">))))</span> <span class="synComment">;フレームなら空ストリームとcons-streamしたストリームを返す</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; パターンとデータが同じならフレームを返し，パターンが(? x)ならextendするか既にある値を返す．</span>
</span><span class="code-line"><span class="synComment">;; マッチしなければそのフレームをfailedにする．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pattern-match pat dat frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">eq?</span> frame <span class="synSpecial">'</span>failed<span class="synSpecial">)</span> <span class="synSpecial">'</span>failed<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">equal?</span> pat dat<span class="synSpecial">)</span> frame<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">((</span>var? pat<span class="synSpecial">)</span>                     <span class="synComment">;patternが(? x)のような形なら</span>
</span><span class="code-line">         <span class="synSpecial">(</span>extend-if-consistent pat dat frame<span class="synSpecial">))</span> <span class="synComment">;ここで値となって戻るか，拡張されて戻る</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> pat<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> dat<span class="synSpecial">))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>pattern-match <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> pat<span class="synSpecial">)</span>
</span><span class="code-line">                        <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> dat<span class="synSpecial">)</span>
</span><span class="code-line">                        <span class="synSpecial">(</span>pattern-match <span class="synSpecial">(</span><span class="synIdentifier">car</span> pat<span class="synSpecial">)</span>
</span><span class="code-line">                                       <span class="synSpecial">(</span><span class="synIdentifier">car</span> dat<span class="synSpecial">)</span>
</span><span class="code-line">                                       frame<span class="synSpecial">)))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">'</span>failed<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; varは(? x)のような形で渡される．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>extend-if-consistent var dat frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>binding <span class="synSpecial">(</span>binding-in-frame var frame<span class="synSpecial">)))</span> <span class="synComment">;assocでframeにvarがあるか探す</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> binding
</span><span class="code-line">        <span class="synComment">;; frameにすでにvarがあればそのvalueを返してパターンマッチにかける</span>
</span><span class="code-line">        <span class="synSpecial">(</span>pattern-match <span class="synSpecial">(</span>binding-value binding<span class="synSpecial">)</span> dat frame<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synComment">;; なければフレームを拡張する．</span>
</span><span class="code-line">        <span class="synSpecial">(</span>extend var dat frame<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 規則とユニフィケーション</span>
</span><span class="code-line"><span class="synComment">;; stream-flatmapはstream-carのストリームをマップしてからstream-cdrにいく</span>
</span><span class="code-line"><span class="synComment">;; interleave-delayedもしているのでcarがnullならばstream-cdrのcarを評価する．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>apply-rules pattern frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-flatmap <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>rule<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>apply-a-rule rule pattern frame<span class="synSpecial">))</span>
</span><span class="code-line">                  <span class="synSpecial">(</span>fetch-rules pattern frame<span class="synSpecial">)))</span> <span class="synComment">;patternで使っているルールを引っ張ってくる</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>apply-a-rule rule query-pattern query-frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>clean-rule <span class="synSpecial">(</span>rename-variables-in rule<span class="synSpecial">)))</span> <span class="synComment">;(? x)を(? id x)にしてclean-ruleに束縛</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>unify-result
</span><span class="code-line">           <span class="synSpecial">(</span>unify-match query-pattern
</span><span class="code-line">                        <span class="synSpecial">(</span>conclusion clean-rule<span class="synSpecial">)</span>
</span><span class="code-line">                        query-frame<span class="synSpecial">)))</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> unify-result <span class="synSpecial">'</span>failed<span class="synSpecial">)</span>
</span><span class="code-line">          the-empty-stream
</span><span class="code-line">          <span class="synSpecial">(</span>qeval <span class="synSpecial">(</span>rule-body clean-rule<span class="synSpecial">)</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>singleton-stream unify-result<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; ruleの中で(? x)となっている部分をすべて(? id x)にして返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>rename-variables-in rule<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>rule-application-id <span class="synSpecial">(</span>new-rule-application-id<span class="synSpecial">)))</span> <span class="synComment">;rule-counterに１足してidに保存</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>tree-walk <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span>var? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">             <span class="synComment">;; (? x)=>(? id x)</span>
</span><span class="code-line">             <span class="synSpecial">(</span>make-new-variable <span class="synIdentifier">exp</span> rule-application-id<span class="synSpecial">))</span>
</span><span class="code-line">            <span class="synSpecial">((</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">             <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>tree-walk <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">                   <span class="synSpecial">(</span>tree-walk <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> <span class="synIdentifier">exp</span><span class="synSpecial">))))</span>
</span><span class="code-line">            <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span>tree-walk rule<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; pattern-matchとほぼ同じ．</span>
</span><span class="code-line"><span class="synComment">;; ユニファイの場合はフレームに入っている値が(? x)の形の場合もあるのでそれに対応</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>unify-match p1 p2 frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">eq?</span> frame <span class="synSpecial">'</span>failed<span class="synSpecial">)</span> <span class="synSpecial">'</span>failed<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">equal?</span> p1 p2<span class="synSpecial">)</span> frame<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">((</span>var? p1<span class="synSpecial">)</span> <span class="synSpecial">(</span>extend-if-possible p1 p2 frame<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>var? p2<span class="synSpecial">)</span> <span class="synSpecial">(</span>extend-if-possible p2 p1 frame<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> p1<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> p2<span class="synSpecial">))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>unify-match <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> p1<span class="synSpecial">)</span>
</span><span class="code-line">                      <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> p2<span class="synSpecial">)</span>
</span><span class="code-line">                      <span class="synSpecial">(</span>unify-match <span class="synSpecial">(</span><span class="synIdentifier">car</span> p1<span class="synSpecial">)</span>
</span><span class="code-line">                                   <span class="synSpecial">(</span><span class="synIdentifier">car</span> p2<span class="synSpecial">)</span>
</span><span class="code-line">                                   frame<span class="synSpecial">)))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">'</span>failed<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; (? x)が値を指していればその値を返す．(? y)となっていれば，さらにその値を探す．</span>
</span><span class="code-line"><span class="synComment">;; varもvalも(? x)同じものを指していればfailedが返る．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>extend-if-possible var val frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>binding <span class="synSpecial">(</span>binding-in-frame var frame<span class="synSpecial">)))</span> <span class="synComment">;フレームからvarに対応するvalを探して束縛</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">(</span>binding
</span><span class="code-line">           <span class="synSpecial">(</span>unify-match <span class="synSpecial">(</span>binding-value binding<span class="synSpecial">)</span> val frame<span class="synSpecial">))</span>
</span><span class="code-line">          <span class="synComment">;; 上のletで探してきたvalもまた(? y)という形だった場合は更にフレームから探してくる．</span>
</span><span class="code-line">          <span class="synSpecial">((</span>var? val<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>binding <span class="synSpecial">(</span>binding-in-frame val frame<span class="synSpecial">)))</span>
</span><span class="code-line">             <span class="synSpecial">(</span><span class="synStatement">if</span> binding
</span><span class="code-line">                 <span class="synSpecial">(</span>unify-match var <span class="synSpecial">(</span>binding-value binding<span class="synSpecial">)</span> frame<span class="synSpecial">)</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>extend var val frame<span class="synSpecial">))))</span> <span class="synComment">;見つからなければフレームを拡張</span>
</span><span class="code-line">          <span class="synSpecial">((</span>depends-on? val var frame<span class="synSpecial">)</span>     <span class="synComment">;valとvarが同じく(? x)だった場合はfailed</span>
</span><span class="code-line">           <span class="synSpecial">'</span>failed<span class="synSpecial">)</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">(</span>extend var val frame<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; vatとexpが同じ(? x)の場合は#tを返す．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>depends-on? <span class="synIdentifier">exp</span> var frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>tree-walk e<span class="synSpecial">)</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span>var? e<span class="synSpecial">)</span>                     <span class="synComment">;(? id x)という形</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">equal?</span> var e<span class="synSpecial">)</span>           <span class="synComment">;varもeも(? x)と同じだった場合</span>
</span><span class="code-line">               <span class="synConstant">#t</span>
</span><span class="code-line">               <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>b <span class="synSpecial">(</span>binding-in-frame e frame<span class="synSpecial">)))</span> <span class="synComment">;eの値を更にフレームから探してくる</span>
</span><span class="code-line">                 <span class="synSpecial">(</span><span class="synStatement">if</span> b
</span><span class="code-line">                     <span class="synSpecial">(</span>tree-walk <span class="synSpecial">(</span>binding-value b<span class="synSpecial">))</span>
</span><span class="code-line">                     <span class="synConstant">#f</span><span class="synSpecial">))))</span>
</span><span class="code-line">          <span class="synSpecial">((</span><span class="synIdentifier">pair?</span> e<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">or</span> <span class="synSpecial">(</span>tree-walk <span class="synSpecial">(</span><span class="synIdentifier">car</span> e<span class="synSpecial">))</span>
</span><span class="code-line">               <span class="synSpecial">(</span>tree-walk <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> e<span class="synSpecial">))))</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synConstant">#f</span><span class="synSpecial">)))</span>
</span><span class="code-line">  <span class="synSpecial">(</span>tree-walk <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; データベース</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> THE-ASSERTIONS the-empty-stream<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; patternの先頭に合うassertionをストリームにして返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>fetch-assertions pattern frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>use-index? pattern<span class="synSpecial">)</span>              <span class="synComment">;patternの先頭がsymbolならtrue</span>
</span><span class="code-line">      <span class="synComment">;; (job ?x ?y)ならjobから始まるデータベースの表明すべてを取ってきてストリームにして返す</span>
</span><span class="code-line">      <span class="synSpecial">(</span>get-indexed-assertions pattern<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synComment">;; データベースのTHE-ASSERTIONSを返す</span>
</span><span class="code-line">      <span class="synSpecial">(</span>get-all-assertions<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-all-assertions<span class="synSpecial">)</span> THE-ASSERTIONS<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; patternの先頭にマッチするassertionを取ってきてストリームにして返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-indexed-assertions pattern<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>get-stream <span class="synSpecial">(</span>index-key-of pattern<span class="synSpecial">)</span> <span class="synSpecial">'</span>assertion-stream<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 表の中からkey1 key2に対応するものを探す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-stream key1 key2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>s <span class="synSpecial">(</span>get key1 key2<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> s s the-empty-stream<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> THE-RULES the-empty-stream<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>fetch-rules pattern frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>use-index? pattern<span class="synSpecial">)</span>              <span class="synComment">;patternの先頭がsymbolならtrue</span>
</span><span class="code-line">      <span class="synComment">;; patternと先頭の要素が同じruleと先頭が?のruleがstream-appendされて返ってくる．</span>
</span><span class="code-line">      <span class="synSpecial">(</span>get-indexed-rules pattern<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>get-all-rules<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-all-rules<span class="synSpecial">)</span> THE-RULES<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; patternと先頭の要素が同じruleと先頭の要素が?のruleがstream-appendされる．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-indexed-rules pattern<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>stream-append
</span><span class="code-line">   <span class="synSpecial">(</span>get-stream <span class="synSpecial">(</span>index-key-of pattern<span class="synSpecial">)</span> <span class="synSpecial">'</span>rule-stream<span class="synSpecial">)</span>
</span><span class="code-line">   <span class="synSpecial">(</span>get-stream <span class="synSpecial">'</span>? <span class="synSpecial">'</span>rule-stream<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; ruleならadd-rule!へ．ruleでなければadd-assertionへ．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>add-rule-or-assertion! assertion<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>rule? assertion<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>add-rule! assertion<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>add-assertion! assertion<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>add-assertion! assertion<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>store-assertion-in-index assertion<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>old-assertions THE-ASSERTIONS<span class="synSpecial">))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">set!</span> THE-ASSERTIONS
</span><span class="code-line">          <span class="synSpecial">(</span>cons-stream assertion old-assertions<span class="synSpecial">))</span>
</span><span class="code-line">    <span class="synSpecial">'</span>ok<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>add-rule! rule<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>store-rule-in-index rule<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>old-rules THE-RULES<span class="synSpecial">))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">set!</span> THE-RULES <span class="synSpecial">(</span>cons-stream rule old-rules<span class="synSpecial">))</span>
</span><span class="code-line">    <span class="synSpecial">'</span>ok<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>store-assertion-in-index assertion<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>indexable? assertion<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>key <span class="synSpecial">(</span>index-key-of assertion<span class="synSpecial">)))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>current-assertion-stream
</span><span class="code-line">               <span class="synSpecial">(</span>get-stream key <span class="synSpecial">'</span>assertion-stream<span class="synSpecial">)))</span>
</span><span class="code-line">          <span class="synSpecial">(</span>put key
</span><span class="code-line">               <span class="synSpecial">'</span>assertion-stream
</span><span class="code-line">               <span class="synSpecial">(</span>cons-stream assertion
</span><span class="code-line">                            current-assertion-stream<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; ruleは(rule (some thing else))という形なので(conclusion rule)で(some thing else)という形にしてpatternに束縛する</span>
</span><span class="code-line"><span class="synComment">;; indexiableならrule-streamにkeyを登録する．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>store-rule-in-index rule<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>pattern <span class="synSpecial">(</span>conclusion rule<span class="synSpecial">)))</span>    <span class="synComment">;rule本体をpatternに束縛</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>indexable? pattern<span class="synSpecial">)</span>            <span class="synComment">;symbol or ?xのような形で#t</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>key <span class="synSpecial">(</span>index-key-of pattern<span class="synSpecial">)))</span> <span class="synComment">;(? key)なら?,(key)ならkeyをkeyに束縛</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>current-rule-stream
</span><span class="code-line">                 <span class="synSpecial">(</span>get-stream key <span class="synSpecial">'</span>rule-stream<span class="synSpecial">)))</span> <span class="synComment">;'rule-streamの中からkeyのストリームを探す</span>
</span><span class="code-line">            <span class="synSpecial">(</span>put key
</span><span class="code-line">                 <span class="synSpecial">'</span>rule-stream
</span><span class="code-line">                 <span class="synSpecial">(</span>cons-stream rule
</span><span class="code-line">                              current-rule-stream<span class="synSpecial">)))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; symbolか?xのような形ならtrueを返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>indexable? pat<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">or</span> <span class="synSpecial">(</span>constant-symbol? <span class="synSpecial">(</span><span class="synIdentifier">car</span> pat<span class="synSpecial">))</span>
</span><span class="code-line">      <span class="synSpecial">(</span>var? <span class="synSpecial">(</span><span class="synIdentifier">car</span> pat<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; リストの先頭が?か調べ，?なら?を．違っていれば先頭の要素をそのまま帰す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>index-key-of pat<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>key <span class="synSpecial">(</span><span class="synIdentifier">car</span> pat<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>var? key<span class="synSpecial">)</span> <span class="synSpecial">'</span>? key<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>use-index? pat<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synComment">;; (symbol? (car pat))</span>
</span><span class="code-line">  <span class="synSpecial">(</span>constant-symbol? <span class="synSpecial">(</span><span class="synIdentifier">car</span> pat<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; ストリーム演算</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; carがnullならcdrをforceするstream-append</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>stream-append-delayed s1 delayed-s2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>stream-null? s1<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">force</span> delayed-s2<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>cons-stream
</span><span class="code-line">       <span class="synSpecial">(</span>stream-car s1<span class="synSpecial">)</span>
</span><span class="code-line">       <span class="synSpecial">(</span>stream-append-delayed <span class="synSpecial">(</span>stream-cdr s1<span class="synSpecial">)</span> delayed-s2<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>interleave-delayed s1 delayed-s2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>stream-null? s1<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">force</span> delayed-s2<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>cons-stream
</span><span class="code-line">       <span class="synSpecial">(</span>stream-car s1<span class="synSpecial">)</span>
</span><span class="code-line">       <span class="synSpecial">(</span>interleave-delayed <span class="synSpecial">(</span><span class="synIdentifier">force</span> delayed-s2<span class="synSpecial">)</span>
</span><span class="code-line">                           <span class="synSpecial">(</span><span class="synStatement">delay</span> <span class="synSpecial">(</span>stream-cdr s1<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; stream-mapをした後にflatten-streamにかけられる．</span>
</span><span class="code-line"><span class="synComment">;; そこでstream-nullなら空ストリームが返る．</span>
</span><span class="code-line"><span class="synComment">;; そこからcdrをdelayしてinterleave-delayedに送られる．</span>
</span><span class="code-line"><span class="synComment">;; carがnullならcdrはforceされる．</span>
</span><span class="code-line"><span class="synComment">;; nullでなければ第一引数のcarをcons-streamし，</span>
</span><span class="code-line"><span class="synComment">;; delayed-s2,(cdr s2)をintegerleave-delayedで交互にconsしていく．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>stream-flatmap proc s<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>flatten-stream <span class="synSpecial">(</span>stream-map proc s<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>flatten-stream stream<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>stream-null? stream<span class="synSpecial">)</span>
</span><span class="code-line">      the-empty-stream
</span><span class="code-line">      <span class="synSpecial">(</span>interleave-delayed
</span><span class="code-line">       <span class="synSpecial">(</span>stream-car stream<span class="synSpecial">)</span>
</span><span class="code-line">       <span class="synSpecial">(</span><span class="synStatement">delay</span> <span class="synSpecial">(</span>flatten-stream <span class="synSpecial">(</span>stream-cdr stream<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>singleton-stream x<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>cons-stream x the-empty-stream<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; 質問の構文手続き</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>type <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>error <span class="synConstant">"Unknown expression TYPE"</span> <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>contents <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>error <span class="synConstant">"Unknown expression CONTENTS"</span> <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; リストの先頭がassert!か判定する</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>assertion-to-be-added? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> <span class="synSpecial">(</span>type <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>assert!<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; assert!のbody部を返す．(assert! (some thing else))</span>
</span><span class="code-line"><span class="synComment">;; (contents exp)でcdrを返し，そのcarを返すので(some thing else)になる．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>add-assertion-body <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synSpecial">(</span>contents <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>empty-conjunction? exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> exps<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>first-conjunct exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> exps<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>rest-conjuncts exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> exps<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>empty-disjunction? exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> exps<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>first-disjunct exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> exps<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>rest-disjuncts exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> exps<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>negated-query exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> exps<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>predicate exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> exps<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>args exps<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> exps<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>rule? statement<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>tagged-list? statement <span class="synSpecial">'</span>rule<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>conclusion rule<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> rule<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>rule-body rule<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> <span class="synSpecial">(</span><span class="synIdentifier">cddr</span> rule<span class="synSpecial">))</span>
</span><span class="code-line">      <span class="synSpecial">'(</span>always-true<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">caddr</span> rule<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>query-syntax-process <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>map-over-symbols expand-question-mark <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; すべての?xとなっているシンボルを(? x)という形に変える．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>map-over-symbols proc <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>map-over-symbols proc <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">               <span class="synSpecial">(</span>map-over-symbols proc <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> <span class="synIdentifier">exp</span><span class="synSpecial">))))</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">symbol?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>proc <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synIdentifier">exp</span><span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; symbolの先頭の文字が?なら(? x)に変える．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>expand-question-mark symbol<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>chars <span class="synSpecial">(</span><span class="synIdentifier">symbol->string</span> symbol<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">string=?</span> <span class="synSpecial">(</span><span class="synIdentifier">substring</span> chars <span class="synConstant">0</span> <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synConstant">"?"</span><span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synIdentifier">list</span> <span class="synSpecial">'</span>?
</span><span class="code-line">              <span class="synSpecial">(</span><span class="synIdentifier">string->symbol</span>
</span><span class="code-line">               <span class="synSpecial">(</span><span class="synIdentifier">substring</span> chars <span class="synConstant">1</span> <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> chars<span class="synSpecial">))))</span>
</span><span class="code-line">        symbol<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>var? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>tagged-list? <span class="synIdentifier">exp</span> <span class="synSpecial">'</span>?<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>constant-symbol? <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol?</span> <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> rule-counter <span class="synConstant">0</span><span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; rule-counterを1増やして返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>new-rule-application-id<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">set!</span> rule-counter <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synConstant">1</span> rule-counter<span class="synSpecial">))</span>
</span><span class="code-line">  rule-counter<span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; (? x)=>(? id x)</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-new-variable var rule-application-id<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">'</span>? <span class="synSpecial">(</span><span class="synIdentifier">cons</span> rule-application-id <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> var<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; (? 5 x)のような形なら"?x-5"にしてから?x-5にする．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>contract-question-mark variable<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">string->symbol</span>
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synIdentifier">string-append</span> <span class="synConstant">"?"</span>
</span><span class="code-line">                  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">number?</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> variable<span class="synSpecial">))</span>
</span><span class="code-line">                      <span class="synSpecial">(</span><span class="synIdentifier">string-append</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol->string</span> <span class="synSpecial">(</span><span class="synIdentifier">caddr</span> variable<span class="synSpecial">))</span>
</span><span class="code-line">                                     <span class="synConstant">"-"</span>
</span><span class="code-line">                                     <span class="synSpecial">(</span><span class="synIdentifier">number->string</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> variable<span class="synSpecial">)))</span>
</span><span class="code-line">                      <span class="synSpecial">(</span><span class="synIdentifier">symbol->string</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> variable<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; フレームと束縛</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-binding variable value<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> variable value<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>binding-variable binding<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">car</span> binding<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>binding-value binding<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> binding<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;; フレームからvariableに対応したvalueを取り出す．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>binding-in-frame variable frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">assoc</span> variable frame<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>extend variable value frame<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>make-binding variable value<span class="synSpecial">)</span> frame<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>tagged-list? <span class="synIdentifier">exp</span> tag<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">pair?</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synIdentifier">exp</span><span class="synSpecial">)</span> tag<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synConstant">#f</span><span class="synSpecial">))</span>
</span></code></pre></div></div></article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"SICP 4.4.4 質問システムの実装","published":"2016/01/21","tags":["scheme","SICP"],"content":"\u003cp\u003eなかなか処理の流れがわからなかったのでコメントを多めにつけてみた．\u003c/p\u003e\n\u003cpre class=\"code lang-scheme\" data-lang=\"scheme\" data-unlink=\"\"\u003e\u003ccode class=\"code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 駆動ループ\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e input-prompt \u003cspan class=\"synConstant\"\u003e\";;; Query input:\"\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e output-prompt \u003cspan class=\"synConstant\"\u003e\";;; Query result:\"\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eprompt-for-input \u003cspan class=\"synIdentifier\"\u003estring\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003estring\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eprompt-for-input input-prompt\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e       \u003cspan class=\"synComment\"\u003e;最初の印字\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eq \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-syntax-process \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eread\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eassertion-to-be-added? q\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule-or-assertion! \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion-body q\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\"Assertion added to data base.\"\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e output-prompt\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisplay-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synComment\"\u003e;; このstream-mapで回答のストリームが作られる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-map\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synComment\"\u003e;; フレームを取り，変数を具体化したもともとの質問のコピーからなるストリームを作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate q frame\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                            \u003cspan class=\"synComment\"\u003e;; unbound-handlerに渡す部分．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ev f\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtract-question-mark v\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synComment\"\u003e;; 質問を満たすフレームのストリーム\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval q \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream \u003cspan class=\"synSpecial\"\u003e'()))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; qevalで作られたストリームのフレームをとqを取る．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame unbound-var-handler\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synComment\"\u003e;; binding-in-frameで(? x)と対応した((? x) Aull DeWitt)のような形で取り出す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synComment\"\u003e;; 取り出した((? x) Aull DeWitt)を(Aull DeWitt)にしてcopyに渡す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synComment\"\u003e;; (? 5 x)を?x-5に変える\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunbound-var-handler \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;リストの形は維持したままcarとcdrをcopyする\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 評価機\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval query frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eqproc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype query\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;queryがandかorから始まるかのチェック\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e qproc\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqproc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents query\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;and, orで始まる場合\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esimple-query query frame-stream\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e  \u003cspan class=\"synComment\"\u003e;それ以外\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 単純質問\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esimple-query query-pattern frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synComment\"\u003e;; carがnullならcdrをforceするappend.find-assertionsでマッチするassertionがなければcdrへ．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efind-assertions query-pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-rules query-pattern frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 合成質問\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econjoin conjuncts frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-conjunction? conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      frame-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econjoin \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-conjuncts conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-conjunct conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      frame-stream\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eand \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval conjoin\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisjoin disjuncts frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-disjunction? disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      the-empty-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-disjunct disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisjoin \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-disjuncts disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                       frame-stream\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eor \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval disjoin\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; フィルタ\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegate operands frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegated-query operands\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enot \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval negate\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elisp-value call frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexecute \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate call\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                               frame\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ev f\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\"Unknown pat var -- LISP-VALUE\"\u003c/span\u003e v\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003elisp-value \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval lisp-value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexecute \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eapply\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeval\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epredicate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e user-initial-environment\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eargs \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ealways-true ignore frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ealways-true \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval always-true\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; パターンマッチにより表明を見つける\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efind-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edatum\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003echeck-an-assertion datum pattern frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synComment\"\u003e;; patternの先頭を見て，それにマッチするassertionをストリームで返す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003echeck-an-assertion assertion query-pat query-frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synComment\"\u003e;;パターンマッチされ，failedになったフレームか，拡張されたフレームが入っている．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ematch-result\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match query-pat assertion query-frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e match-result \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        the-empty-stream                \u003cspan class=\"synComment\"\u003e;failedなら空のストリームを返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream match-result\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;フレームなら空ストリームとcons-streamしたストリームを返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; パターンとデータが同じならフレームを返し，パターンが(? x)ならextendするか既にある値を返す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; マッチしなければそのフレームをfailedにする．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match pat dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e frame \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e pat dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                     \u003cspan class=\"synComment\"\u003e;patternが(? x)のような形なら\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-consistent pat dat frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;ここで値となって戻るか，拡張されて戻る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                       frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; varは(? x)のような形で渡される．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-consistent var dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame var frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;assocでframeにvarがあるか探す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; frameにすでにvarがあればそのvalueを返してパターンマッチにかける\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; なければフレームを拡張する．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var dat frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 規則とユニフィケーション\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; stream-flatmapはstream-carのストリームをマップしてからstream-cdrにいく\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; interleave-delayedもしているのでcarがnullならばstream-cdrのcarを評価する．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-a-rule rule pattern frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;patternで使っているルールを引っ張ってくる\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-a-rule rule query-pattern query-frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eclean-rule \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erename-variables-in rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;(? x)を(? id x)にしてclean-ruleに束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eunify-result\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match query-pattern\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion clean-rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                        query-frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e unify-result \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          the-empty-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule-body clean-rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream unify-result\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; ruleの中で(? x)となっている部分をすべて(? id x)にして返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erename-variables-in rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003erule-application-id \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-rule-application-id\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;rule-counterに１足してidに保存\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synComment\"\u003e;; (? x)=\u003e(? id x)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-new-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e rule-application-id\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; pattern-matchとほぼ同じ．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; ユニファイの場合はフレームに入っている値が(? x)の形の場合もあるのでそれに対応\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match p1 p2 frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e frame \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e p1 p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible p1 p2 frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible p2 p1 frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                   frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; (? x)が値を指していればその値を返す．(? y)となっていれば，さらにその値を探す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; varもvalも(? x)同じものを指していればfailedが返る．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible var val frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame var frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;フレームからvarに対応するvalを探して束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e val frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synComment\"\u003e;; 上のletで探してきたvalもまた(? y)という形だった場合は更にフレームから探してくる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame val frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match var \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var val frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;見つからなければフレームを拡張\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003edepends-on? val var frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;valとvarが同じく(? x)だった場合はfailed\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var val frame\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; vatとexpが同じ(? x)の場合は#tを返す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edepends-on? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e var frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                     \u003cspan class=\"synComment\"\u003e;(? id x)という形\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e var e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e           \u003cspan class=\"synComment\"\u003e;varもeも(? x)と同じだった場合\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synConstant\"\u003e#t\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eb \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame e frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;eの値を更にフレームから探してくる\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e b\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value b\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eor\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; データベース\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e THE-ASSERTIONS the-empty-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; patternの先頭に合うassertionをストリームにして返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e              \u003cspan class=\"synComment\"\u003e;patternの先頭がsymbolならtrue\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synComment\"\u003e;; (job ?x ?y)ならjobから始まるデータベースの表明すべてを取ってきてストリームにして返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-assertions pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synComment\"\u003e;; データベースのTHE-ASSERTIONSを返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-assertions\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-assertions\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e THE-ASSERTIONS\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; patternの先頭にマッチするassertionを取ってきてストリームにして返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-assertions pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 表の中からkey1 key2に対応するものを探す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key1 key2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003es \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget key1 key2\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e s s the-empty-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e THE-RULES the-empty-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e              \u003cspan class=\"synComment\"\u003e;patternの先頭がsymbolならtrue\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synComment\"\u003e;; patternと先頭の要素が同じruleと先頭が?のruleがstream-appendされて返ってくる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-rules pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-rules\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-rules\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e THE-RULES\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; patternと先頭の要素が同じruleと先頭の要素が?のruleがstream-appendされる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-rules pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; ruleならadd-rule!へ．ruleでなければadd-assertionへ．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule-or-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule? assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-assertion-in-index assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eold-assertions THE-ASSERTIONS\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e THE-ASSERTIONS\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream assertion old-assertions\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eok\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule! rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-rule-in-index rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eold-rules THE-RULES\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e THE-RULES \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream rule old-rules\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eok\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-assertion-in-index assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of assertion\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecurrent-assertion-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput key\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream assertion\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                            current-assertion-stream\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; ruleは(rule (some thing else))という形なので(conclusion rule)で(some thing else)という形にしてpatternに束縛する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; indexiableならrule-streamにkeyを登録する．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-rule-in-index rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003epattern \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e    \u003cspan class=\"synComment\"\u003e;rule本体をpatternに束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e            \u003cspan class=\"synComment\"\u003e;symbol or ?xのような形で#t\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;(? key)なら?,(key)ならkeyをkeyに束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecurrent-rule-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;'rule-streamの中からkeyのストリームを探す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput key\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream rule\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              current-rule-stream\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; symbolか?xのような形ならtrueを返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eor\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; リストの先頭が?か調べ，?なら?を．違っていれば先頭の要素をそのまま帰す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? key\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? key\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synComment\"\u003e;; (symbol? (car pat))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; ストリーム演算\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; carがnullならcdrをforceするstream-append\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed s1 delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed s1 delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr s1\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; stream-mapをした後にflatten-streamにかけられる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; そこでstream-nullなら空ストリームが返る．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; そこからcdrをdelayしてinterleave-delayedに送られる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; carがnullならcdrはforceされる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; nullでなければ第一引数のcarをcons-streamし，\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; delayed-s2,(cdr s2)をintegerleave-delayedで交互にconsしていく．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap proc s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-map proc s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      the-empty-stream\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr stream\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream x\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream x the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; 質問の構文手続き\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\"Unknown expression TYPE\"\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\"Unknown expression CONTENTS\"\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; リストの先頭がassert!か判定する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassertion-to-be-added? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassert!\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; assert!のbody部を返す．(assert! (some thing else))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; (contents exp)でcdrを返し，そのcarを返すので(some thing else)になる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-conjunction? exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-conjunct exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-conjuncts exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-disjunction? exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-disjunct exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-disjuncts exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegated-query exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epredicate exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eargs exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule? statement\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? statement \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule-body rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecddr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003ealways-true\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-syntax-process \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols expand-question-mark \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; すべての?xとなっているシンボルを(? x)という形に変える．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eproc \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; symbolの先頭の文字が?なら(? x)に変える．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexpand-question-mark symbol\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003echars \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u003estring\u003c/span\u003e symbol\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring=?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esubstring\u003c/span\u003e chars \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\"?\"\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e?\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u003esymbol\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esubstring\u003c/span\u003e chars \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-length\u003c/span\u003e chars\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        symbol\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e?\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e rule-counter \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; rule-counterを1増やして返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-rule-application-id\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e rule-counter \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e+\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e rule-counter\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  rule-counter\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; (? x)=\u003e(? id x)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-new-variable var rule-application-id\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e rule-application-id \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e var\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; (? 5 x)のような形なら\"?x-5\"にしてから?x-5にする．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtract-question-mark variable\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u003esymbol\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\"?\"\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u003estring\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                     \u003cspan class=\"synConstant\"\u003e\"-\"\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber-\u003estring\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u003estring\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; フレームと束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-binding variable value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e variable value\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-variable binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;; フレームからvariableに対応したvalueを取り出す．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame variable frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eassoc\u003c/span\u003e variable frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend variable value frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-binding variable value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e tag\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e tag\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e","slug":"SICP 4.4.4 質問システムの実装","rawContent":"\n\u003cp\u003eなかなか処理の流れがわからなかったのでコメントを多めにつけてみた．\u003c/p\u003e\n\n\u003cpre class=\"code lang-scheme\" data-lang=\"scheme\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e;; 駆動ループ\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e input-prompt \u003cspan class=\"synConstant\"\u003e\u0026quot;;;; Query input:\u0026quot;\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e output-prompt \u003cspan class=\"synConstant\"\u003e\u0026quot;;;; Query result:\u0026quot;\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eprompt-for-input \u003cspan class=\"synIdentifier\"\u003estring\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003estring\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eprompt-for-input input-prompt\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e       \u003cspan class=\"synComment\"\u003e;最初の印字\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eq \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-syntax-process \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eread\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eassertion-to-be-added? q\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule-or-assertion! \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion-body q\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;Assertion added to data base.\u0026quot;\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enewline\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003edisplay\u003c/span\u003e output-prompt\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisplay-stream\n            \u003cspan class=\"synComment\"\u003e;; このstream-mapで回答のストリームが作られる．\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-map\n             \u003cspan class=\"synComment\"\u003e;; フレームを取り，変数を具体化したもともとの質問のコピーからなるストリームを作る\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate q frame\n                            \u003cspan class=\"synComment\"\u003e;; unbound-handlerに渡す部分．\u003c/span\u003e\n                            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ev f\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtract-question-mark v\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n             \u003cspan class=\"synComment\"\u003e;; 質問を満たすフレームのストリーム\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval q \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream \u003cspan class=\"synSpecial\"\u003e'()))))\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-driver-loop\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; qevalで作られたストリームのフレームをとqを取る．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame unbound-var-handler\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synComment\"\u003e;; binding-in-frameで(? x)と対応した((? x) Aull DeWitt)のような形で取り出す．\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n                 \u003cspan class=\"synComment\"\u003e;; 取り出した((? x) Aull DeWitt)を(Aull DeWitt)にしてcopyに渡す．\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                 \u003cspan class=\"synComment\"\u003e;; (? 5 x)を?x-5に変える\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunbound-var-handler \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;リストの形は維持したままcarとcdrをcopyする\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecopy \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 評価機\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval query frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eqproc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype query\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;queryがandかorから始まるかのチェック\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e qproc\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqproc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents query\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;and, orで始まる場合\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esimple-query query frame-stream\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e  \u003cspan class=\"synComment\"\u003e;それ以外\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 単純質問\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esimple-query query-pattern frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"synComment\"\u003e;; carがnullならcdrをforceするappend.find-assertionsでマッチするassertionがなければcdrへ．\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efind-assertions query-pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-rules query-pattern frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 合成質問\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econjoin conjuncts frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-conjunction? conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      frame-stream\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econjoin \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-conjuncts conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-conjunct conjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      frame-stream\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eand \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval conjoin\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisjoin disjuncts frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-disjunction? disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      the-empty-stream\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-disjunct disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edisjoin \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-disjuncts disjuncts\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                       frame-stream\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eor \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval disjoin\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; フィルタ\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegate operands frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegated-query operands\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enot \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval negate\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elisp-value call frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eframe\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexecute \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einstantiate call\n                               frame\n                               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ev f\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\u0026quot;Unknown pat var -- LISP-VALUE\u0026quot;\u003c/span\u003e v\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n   frame-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003elisp-value \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval lisp-value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexecute \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eapply\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeval\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epredicate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e user-initial-environment\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eargs \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ealways-true ignore frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ealways-true \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eqeval always-true\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; パターンマッチにより表明を見つける\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efind-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edatum\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003echeck-an-assertion datum pattern frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                  \u003cspan class=\"synComment\"\u003e;; patternの先頭を見て，それにマッチするassertionをストリームで返す．\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003echeck-an-assertion assertion query-pat query-frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synComment\"\u003e;;パターンマッチされ，failedになったフレームか，拡張されたフレームが入っている．\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ematch-result\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match query-pat assertion query-frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e match-result \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        the-empty-stream                \u003cspan class=\"synComment\"\u003e;failedなら空のストリームを返す\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream match-result\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;フレームなら空ストリームとcons-streamしたストリームを返す\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; パターンとデータが同じならフレームを返し，パターンが(? x)ならextendするか既にある値を返す．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; マッチしなければそのフレームをfailedにする．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match pat dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e frame \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e pat dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                     \u003cspan class=\"synComment\"\u003e;patternが(? x)のような形なら\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-consistent pat dat frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;ここで値となって戻るか，拡張されて戻る\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e dat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                       frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; varは(? x)のような形で渡される．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-consistent var dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame var frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;assocでframeにvarがあるか探す\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n        \u003cspan class=\"synComment\"\u003e;; frameにすでにvarがあればそのvalueを返してパターンマッチにかける\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epattern-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e dat frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; なければフレームを拡張する．\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var dat frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 規則とユニフィケーション\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; stream-flatmapはstream-carのストリームをマップしてからstream-cdrにいく\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; interleave-delayedもしているのでcarがnullならばstream-cdrのcarを評価する．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-a-rule rule pattern frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;patternで使っているルールを引っ張ってくる\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eapply-a-rule rule query-pattern query-frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eclean-rule \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erename-variables-in rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;(? x)を(? id x)にしてclean-ruleに束縛\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eunify-result\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match query-pattern\n                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion clean-rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                        query-frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e unify-result \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n          the-empty-stream\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eqeval \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule-body clean-rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream unify-result\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; ruleの中で(? x)となっている部分をすべて(? id x)にして返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erename-variables-in rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003erule-application-id \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-rule-application-id\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;rule-counterに１足してidに保存\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"synComment\"\u003e;; (? x)=\u0026gt;(? id x)\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-new-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e rule-application-id\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; pattern-matchとほぼ同じ．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; ユニファイの場合はフレームに入っている値が(? x)の形の場合もあるのでそれに対応\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match p1 p2 frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e frame \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e p1 p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible p1 p2 frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible p2 p1 frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e p1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e p2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                   frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; (? x)が値を指していればその値を返す．(? y)となっていれば，さらにその値を探す．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; varもvalも(? x)同じものを指していればfailedが返る．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend-if-possible var val frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame var frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;フレームからvarに対応するvalを探して束縛\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e val frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n          \u003cspan class=\"synComment\"\u003e;; 上のletで探してきたvalもまた(? y)という形だった場合は更にフレームから探してくる．\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebinding \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame val frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e binding\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eunify-match var \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var val frame\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;見つからなければフレームを拡張\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003edepends-on? val var frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;valとvarが同じく(? x)だった場合はfailed\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efailed\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend var val frame\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\n\u003cspan class=\"synComment\"\u003e;; vatとexpが同じ(? x)の場合は#tを返す．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edepends-on? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e var frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar? e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                     \u003cspan class=\"synComment\"\u003e;(? id x)という形\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eequal?\u003c/span\u003e var e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e           \u003cspan class=\"synComment\"\u003e;varもeも(? x)と同じだった場合\u003c/span\u003e\n               \u003cspan class=\"synConstant\"\u003e#t\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eb \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame e frame\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;eの値を更にフレームから探してくる\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e b\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value b\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                     \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eor\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etree-walk \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; データベース\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e THE-ASSERTIONS the-empty-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; patternの先頭に合うassertionをストリームにして返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-assertions pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e              \u003cspan class=\"synComment\"\u003e;patternの先頭がsymbolならtrue\u003c/span\u003e\n      \u003cspan class=\"synComment\"\u003e;; (job ?x ?y)ならjobから始まるデータベースの表明すべてを取ってきてストリームにして返す\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-assertions pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synComment\"\u003e;; データベースのTHE-ASSERTIONSを返す\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-assertions\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-assertions\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e THE-ASSERTIONS\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; patternの先頭にマッチするassertionを取ってきてストリームにして返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-assertions pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 表の中からkey1 key2に対応するものを探す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key1 key2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003es \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget key1 key2\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e s s the-empty-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e THE-RULES the-empty-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efetch-rules pattern frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e              \u003cspan class=\"synComment\"\u003e;patternの先頭がsymbolならtrue\u003c/span\u003e\n      \u003cspan class=\"synComment\"\u003e;; patternと先頭の要素が同じruleと先頭が?のruleがstream-appendされて返ってくる．\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-rules pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-rules\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-all-rules\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e THE-RULES\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; patternと先頭の要素が同じruleと先頭の要素が?のruleがstream-appendされる．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-indexed-rules pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; ruleならadd-rule!へ．ruleでなければadd-assertionへ．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule-or-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule? assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion! assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-assertion-in-index assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eold-assertions THE-ASSERTIONS\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e THE-ASSERTIONS\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream assertion old-assertions\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eok\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-rule! rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-rule-in-index rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eold-rules THE-RULES\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e THE-RULES \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream rule old-rules\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eok\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-assertion-in-index assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? assertion\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of assertion\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecurrent-assertion-stream\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput key\n               \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassertion-stream\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream assertion\n                            current-assertion-stream\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; ruleは(rule (some thing else))という形なので(conclusion rule)で(some thing else)という形にしてpatternに束縛する\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; indexiableならrule-streamにkeyを登録する．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estore-rule-in-index rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003epattern \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e    \u003cspan class=\"synComment\"\u003e;rule本体をpatternに束縛\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? pattern\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e            \u003cspan class=\"synComment\"\u003e;symbol or ?xのような形で#t\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pattern\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;(? key)なら?,(key)ならkeyをkeyに束縛\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecurrent-rule-stream\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-stream key \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;'rule-streamの中からkeyのストリームを探す\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eput key\n                 \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule-stream\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream rule\n                              current-rule-stream\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; symbolか?xのような形ならtrueを返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindexable? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eor\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; リストの先頭が?か調べ，?なら?を．違っていれば先頭の要素をそのまま帰す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eindex-key-of pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ekey \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? key\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? key\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003euse-index? pat\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synComment\"\u003e;; (symbol? (car pat))\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e pat\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; ストリーム演算\u003c/span\u003e\n\n\n\u003cspan class=\"synComment\"\u003e;; carがnullならcdrをforceするstream-append\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed s1 delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-append-delayed \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed s1 delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eforce\u003c/span\u003e delayed-s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr s1\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; stream-mapをした後にflatten-streamにかけられる．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; そこでstream-nullなら空ストリームが返る．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; そこからcdrをdelayしてinterleave-delayedに送られる．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; carがnullならcdrはforceされる．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; nullでなければ第一引数のcarをcons-streamし，\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; delayed-s2,(cdr s2)をintegerleave-delayedで交互にconsしていく．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-flatmap proc s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-map proc s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-null? stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      the-empty-stream\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003einterleave-delayed\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-car stream\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edelay\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eflatten-stream \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estream-cdr stream\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003esingleton-stream x\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econs-stream x the-empty-stream\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; 質問の構文手続き\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\u0026quot;Unknown expression TYPE\u0026quot;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\u0026quot;Unknown expression CONTENTS\u0026quot;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; リストの先頭がassert!か判定する\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassertion-to-be-added? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etype \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eassert!\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; assert!のbody部を返す．(assert! (some thing else))\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;; (contents exp)でcdrを返し，そのcarを返すので(some thing else)になる．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eadd-assertion-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtents \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-conjunction? exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-conjunct exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-conjuncts exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-disjunction? exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-disjunct exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-disjuncts exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enegated-query exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epredicate exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eargs exps\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e exps\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule? statement\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? statement \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003erule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econclusion rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erule-body rule\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecddr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003ealways-true\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e rule\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003equery-syntax-process \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols expand-question-mark \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; すべての?xとなっているシンボルを(? x)という形に変える．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emap-over-symbols proc \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eproc \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; symbolの先頭の文字が?なら(? x)に変える．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eexpand-question-mark symbol\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003echars \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u0026gt;string\u003c/span\u003e symbol\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring=?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esubstring\u003c/span\u003e chars \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;?\u0026quot;\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e?\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u0026gt;symbol\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esubstring\u003c/span\u003e chars \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-length\u003c/span\u003e chars\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n        symbol\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003evar? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e?\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstant-symbol? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e rule-counter \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; rule-counterを1増やして返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-rule-application-id\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e rule-counter \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e+\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e rule-counter\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n  rule-counter\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; (? x)=\u0026gt;(? id x)\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-new-variable var rule-application-id\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e? \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e rule-application-id \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e var\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; (? 5 x)のような形なら\u0026quot;?x-5\u0026quot;にしてから?x-5にする．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econtract-question-mark variable\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u0026gt;symbol\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;?\u0026quot;\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u0026gt;string\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                                     \u003cspan class=\"synConstant\"\u003e\u0026quot;-\u0026quot;\u003c/span\u003e\n                                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber-\u0026gt;string\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u0026gt;string\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e variable\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; フレームと束縛\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-binding variable value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e variable value\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-variable binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-value binding\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e binding\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;; フレームからvariableに対応したvalueを取り出す．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebinding-in-frame variable frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eassoc\u003c/span\u003e variable frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eextend variable value frame\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-binding variable value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e frame\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e tag\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003epair?\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e tag\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synConstant\"\u003e#f\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/pre\u003e\n\n\n"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"SICP 4.4.4 質問システムの実装"},"buildId":"wu5pd2semhKOEcEl6RoK2","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>