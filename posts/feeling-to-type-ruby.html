<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Ruby に型をつけるお気持ち | (wat-aro)</title><meta name="next-head-count" content="3"/><link rel="icon" href="/images/favicon.ico"/><link rel="preload" href="/_next/static/css/16c3954b87244972.css" as="style"/><link rel="stylesheet" href="/_next/static/css/16c3954b87244972.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-30ca6ce23cf83cd1.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-36fb89e31f7cc580.js" defer=""></script><script src="/_next/static/0LF11L4L0UyFQzc9l6CxC/_buildManifest.js" defer=""></script><script src="/_next/static/0LF11L4L0UyFQzc9l6CxC/_ssgManifest.js" defer=""></script><script src="/_next/static/0LF11L4L0UyFQzc9l6CxC/_middlewareManifest.js" defer=""></script></head><body><noscript>
            <iframe
              src="https://www.googletagmanager.com/ns.html?id=GTM-MW6D56L"
              height="0"
              width="0"
              style="display:none;visibility:hidden"
            /></noscript><div id="__next"><div class="py-0 md:px-8 min-h-screen flex flex-col items-center"><div class="sticky top-0 bg-white w-full h-16 flex flex-row justify-between items-center px-4 border-b-2"><a href="/"><div class="flex items-center font-midium text-3xl h-full font-bold gap-4"><img class="rounded-full" src="/images/profile.jpg" width="48" height="48" alt="profile image"/>(wat-aro)<!-- --></div></a><ul class="flex gap-3 h-full"><li class="h-full  flex flex-col justify-end border-black pb-4"><a href="/about">About</a></li><li class="h-full  flex flex-col justify-end border-black pb-3 border-b-4"><a href="/posts">Blog</a></li></ul></div><div class="flex md:justify-center justify-between w-full"><div class="flex flex-col sm:max-w-sm md:max-w-4xl w-full py-4 px-4"><article class="flex max-w-4xl w-full"><div class="py-4 w-full"><div class="mr-2 text-xs font-bold">2020-01-15</div><h1 class="font-bold text-3xl text-black">Ruby に型をつけるお気持ち</h1><nav class="flex mt-7 items-start text-gray-500"><div class="flex flex-nowrap max-w-full overflow-x-auto"></div></nav><div class="znc"><h1>Ruby に型をつけるお気持ち</h1>
<p>wat-aro</p>
<hr>
<h2>自己紹介</h2>
<ul>
<li>wat-aro</li>
<li>Haskell, Elm なんかが好き</li>
</ul>
<hr>
<h2>おしながき</h2>
<ul>
<li>Ruby の型のおさらい</li>
<li>ruby-signature の記法</li>
<li>実例を通して</li>
</ul>
<hr>
<h3><code>Ruby</code> の型のおさらい</h3>
<ul>
<li>型検査器 steep, sorbet</li>
<li>rbi ファイルに型定義を書くがそれぞれ文法が違う</li>
<li>Ruby 3 では型シグネチャが導入される</li>
<li>周辺ツール群は外部ライブラリとして提供</li>
</ul>
<hr>
<h3><code>Ruby</code> の型シグナチャ</h3>
<ul>
<li>ruby-signature</li>
<li><a href="https://github.com/ruby/ruby-signature">https://github.com/ruby/ruby-signature</a></li>
<li>steep, sorbet にこのシグネチャを使ってもらう</li>
</ul>
<hr>
<hr>
<h2><code>ruby-signature</code> の記法</h2>
<ul>
<li>プリミティブな型は Class instance type で定義</li>
<li>Interface type であるメソッドを持った型というのも定義できる</li>
<li>Literal type, Union Type, Intersection type, Optional type で柔軟な型定義ができる</li>
<li>ivar や メソッドの型定義も直観的</li>
<li>型付けできないものは <code>untyped</code></li>
</ul>
<hr>
<h3>プリミティブな型</h3>
<ul>
<li>Integer</li>
<li>String</li>
<li>Hash[Symbol, String]</li>
</ul>
<hr>
<h3><code>Record type</code></h3>
<ul>
<li>Hash の型を指定</li>
<li><code>{ id: Integer, name: String }</code></li>
</ul>
<hr>
<h3><code>Interface type</code></h3>
<p>例: each メソッドを持っている型</p>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">interface _Each<span class="token punctuation">[</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">each</span></span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> void <span class="token punctuation">}</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">B</span>
</span><span class="code-line"><span class="token keyword">end</span>
</span></code></pre>
<hr>
<h3><code>Literal type</code></h3>
<ul>
<li>型の取り得る値を限定できる</li>
<li><code>1</code> という型は Integer かつ 値を <code>1</code> に限定</li>
<li>"hello world"という型や<code>:to_s</code>という型を定義可能</li>
</ul>
<hr>
<h3><code>Union type</code></h3>
<ul>
<li>型の和を表わす</li>
<li><code>Integer | String</code> は Integer or String</li>
</ul>
<hr>
<h3><code>Intersection type</code></h3>
<ul>
<li>交差型</li>
<li><code>Integer &#x26; String</code> は Integer and String</li>
<li>Hash の合成が主な用途？</li>
<li><code>{ id: Integer } &#x26; { name: String }</code> は <code>{ id: Integer, name: String }</code></li>
</ul>
<hr>
<h3><code>Optional type</code></h3>
<ul>
<li>みんな大好き null 安全</li>
<li><code>Integer?</code> で <code>Integer | nil</code></li>
</ul>
<hr>
<h3>ivar やメソッドの型定義</h3>
<ul>
<li><code>@name: String</code> で ivar</li>
<li><code>def to_s: () -> String</code> でメソッドを定義</li>
</ul>
<hr>
<h3>所見</h3>
<ul>
<li>TypeScript の影響が強い
<ul>
<li>Literal type</li>
<li>Intersection type</li>
</ul>
</li>
<li>Interface type があればダックタイプもやりやすそう</li>
<li>想像していたよりもリッチ</li>
<li>any じゃなくて untyped なのはわかりやすくていい</li>
</ul>
<hr>
<hr>
<h2>実例を通して</h2>
<p>ruby-signature はまだ StandardLibrary の片付けが終わっていないので
適当なものに型をつけてみる</p>
<hr>
<h3>Abbrev モジュール</h3>
<ul>
<li>StandardLibrary で最初に表示されている</li>
<li>module_function abbrev 一つだけのモジュールなので簡単</li>
<li>まだ ruby-signature で定義されていない</li>
</ul>
<hr>
<h3>Abbrev#abbrev とは</h3>
<p><code>abbrev(words, pattern = nil)</code></p>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'ruby'</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=>  {"ruby"=>"ruby", "rub"=>"ruby", "ru"=>"ruby", "r"=>"ruby"}</span>
</span><span class="code-line">
</span><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{ car cone }</span></span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {"ca"=>"car", "con"=>"cone", "co"=>"cone", "car"=>"car", "cone"=>"cone"}</span>
</span><span class="code-line">
</span><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{car box cone crab}</span></span><span class="token punctuation">,</span> <span class="token regex-literal"><span class="token regex">/b/</span></span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {"box"=>"box", "bo"=>"box", "b"=>"box", "crab" => "crab"}</span>
</span><span class="code-line">
</span><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{car box cone}</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'ca'</span></span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {"car"=>"car", "ca"=>"car"}</span>
</span></code></pre>
<p>String の配列をうけとり、String を分解して key とし、元の String を value とする Hash を返す</p>
<hr>
<h3>まずはシンプルなケース</h3>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'ruby'</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=>  {"ruby"=>"ruby", "rub"=>"ruby", "ru"=>"ruby", "r"=>"ruby"}</span>
</span></code></pre>
<p>これに型を付けると</p>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line"><span class="token keyword">module</span> <span class="token class-name">Abbrev</span>
</span><span class="code-line">  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">self</span></span><span class="token operator">?</span><span class="token punctuation">.</span>abbrev<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Hash</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>
</span><span class="code-line"><span class="token keyword">end</span>
</span></code></pre>
<p><code>def self?</code> は module function 用の書き方
空配列を受け取っても空ハッシュを返すだけなので問題なし。</p>
<hr>
<h3>第 2 引数について</h3>
<p>example を見ると String と Regexp を受け取ることを想定しているよう</p>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{car box cone crab}</span></span><span class="token punctuation">,</span> <span class="token regex-literal"><span class="token regex">/b/</span></span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {"box"=>"box", "bo"=>"box", "b"=>"box", "crab" => "crab"}</span>
</span><span class="code-line">
</span><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{car box cone}</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'ca'</span></span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {"car"=>"car", "ca"=>"car"}</span>
</span></code></pre>
<p>じゃあ Integer とか渡したらエラーになるのかな？</p>
<hr>
<h3>想定していなさそうな型の引数を渡してみる</h3>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">%w{12345}</span></span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {}</span>
</span></code></pre>
<p>エラーにならないだと…
この場合って型はどうつければいいのか。
実装を abbrev の実装を見てみると</p>
<hr>
<h3>abbrev の実装</h3>
<ul>
<li>String, Regexp 以外は <code>!~</code> を直接使っている</li>
<li><code>Integer#!~</code> は常に true を返す</li>
</ul>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">abbrev</span></span><span class="token punctuation">(</span>words<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token operator">...</span>
</span><span class="code-line">  <span class="token keyword">if</span> pattern<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">)</span>
</span><span class="code-line">    pattern <span class="token operator">=</span> <span class="token regex-literal"><span class="token regex">/\A</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token builtin">Regexp</span><span class="token punctuation">.</span>quote<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span></span><span class="token delimiter punctuation">}</span></span><span class="token regex">/</span></span>  <span class="token comment"># regard as a prefix</span>
</span><span class="code-line">  <span class="token keyword">end</span>
</span></code></pre>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">  words<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>word<span class="token operator">|</span>
</span><span class="code-line">    <span class="token keyword">next</span> <span class="token keyword">if</span> word<span class="token punctuation">.</span>empty<span class="token operator">?</span>
</span><span class="code-line">    word<span class="token punctuation">.</span>size<span class="token punctuation">.</span>downto<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>len<span class="token operator">|</span>
</span><span class="code-line">      abbrev <span class="token operator">=</span> word<span class="token punctuation">[</span><span class="token number">0.</span><span class="token operator">..</span>len<span class="token punctuation">]</span>
</span><span class="code-line">      <span class="token keyword">next</span> <span class="token keyword">if</span> pattern <span class="token operator">&#x26;&#x26;</span> pattern <span class="token operator">!~</span> abbrev
</span><span class="code-line">      <span class="token operator">...</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token keyword">end</span>
</span><span class="code-line"><span class="token keyword">end</span>
</span></code></pre>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line">  words<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>word<span class="token operator">|</span>
</span><span class="code-line">    <span class="token keyword">next</span> <span class="token keyword">if</span> pattern <span class="token operator">&#x26;&#x26;</span> pattern <span class="token operator">!~</span> word
</span><span class="code-line">    table<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> word
</span><span class="code-line">  <span class="token keyword">end</span>
</span><span class="code-line">  table
</span><span class="code-line"><span class="token keyword">end</span>
</span></code></pre>
<hr>
<h3>abbrev の第 2 引数は String, Regexp 以外を考慮していない</h3>
<ul>
<li>String, Regexp 以外を考慮しておらず、たまたま <code>{}</code> を返すようになっているだけに見える</li>
<li>実行時にエラーにならない場合はどう型をつければよいのか
<ul>
<li>Integer or Object を引数に取ることを認める</li>
<li>String と Regexp 以外は認めない</li>
</ul>
</li>
</ul>
<hr>
<h3>このような場合にどうすればよいか</h3>
<ul>
<li>ドキュメントにどう書かれているか</li>
<li>エラーでないために困る場合を想定してどう検査してほしいかを考える</li>
</ul>
<hr>
<h3>ドキュメント</h3>
<blockquote>
<p>The optional pattern parameter is a pattern or a string.
Only input strings that match the pattern or start with the string are included in the output hash.</p>
</blockquote>
<p>pattern とは言っているけれど、それが Regexp とは限定していない。</p>
<hr>
<h3>エラーでないために困る場合を想定してどう検査してほしいかを考える</h3>
<p>何かのメソッドの返り値が String や Regexp だと思っていたのに Integer だった場合</p>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">some_method</span></span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">String</span> <span class="token operator">|</span> <span class="token builtin">Integer</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">pattern <span class="token operator">=</span> some_method<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">Abbrev<span class="token punctuation">.</span>abbrev<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"12345"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#=> {}</span>
</span></code></pre>
<p>Integer が来てここでエラーにならなくてもその後で不整合がおこる場合に困る。
ここを通るテストがない場合になぜ駄目なのかの調査が必要になる。
それよりも型検査で弾いてくれたほうが嬉しい。</p>
<hr>
<h3>結果</h3>
<pre class="language-ruby"><code class="language-ruby code-highlight"><span class="code-line"><span class="token keyword">module</span> <span class="token class-name">Abbrev</span>
</span><span class="code-line">  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">self</span></span><span class="token operator">?</span><span class="token punctuation">.</span>abbrev<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">String</span> <span class="token operator">|</span> <span class="token builtin">Regexp</span> <span class="token operator">|</span> <span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Hash</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>
</span><span class="code-line"><span class="token keyword">end</span>
</span><span class="code-line">
</span></code></pre>
<p>第 2 引数は String, Regexp, nil としました。
この定義で ruby-signature に PR を送ってマージされた。</p>
<hr>
<h2>まとめ</h2>
<ul>
<li>ruby-signature の紹介</li>
<li>ドキュメントにない場合でもそれっぽく動く場合がある</li>
<li>どう動いてほしいかを考えて型をつけないといけない場合がある</li>
</ul></div></div></article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Ruby に型をつけるお気持ち","published":"2020-01-15","content":"\u003ch1\u003eRuby に型をつけるお気持ち\u003c/h1\u003e\n\u003cp\u003ewat-aro\u003c/p\u003e\n\u003chr\u003e\n\u003ch2\u003e自己紹介\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003ewat-aro\u003c/li\u003e\n\u003cli\u003eHaskell, Elm なんかが好き\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2\u003eおしながき\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eRuby の型のおさらい\u003c/li\u003e\n\u003cli\u003eruby-signature の記法\u003c/li\u003e\n\u003cli\u003e実例を通して\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eRuby\u003c/code\u003e の型のおさらい\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e型検査器 steep, sorbet\u003c/li\u003e\n\u003cli\u003erbi ファイルに型定義を書くがそれぞれ文法が違う\u003c/li\u003e\n\u003cli\u003eRuby 3 では型シグネチャが導入される\u003c/li\u003e\n\u003cli\u003e周辺ツール群は外部ライブラリとして提供\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eRuby\u003c/code\u003e の型シグナチャ\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eruby-signature\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/ruby/ruby-signature\"\u003ehttps://github.com/ruby/ruby-signature\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003esteep, sorbet にこのシグネチャを使ってもらう\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003chr\u003e\n\u003ch2\u003e\u003ccode\u003eruby-signature\u003c/code\u003e の記法\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eプリミティブな型は Class instance type で定義\u003c/li\u003e\n\u003cli\u003eInterface type であるメソッドを持った型というのも定義できる\u003c/li\u003e\n\u003cli\u003eLiteral type, Union Type, Intersection type, Optional type で柔軟な型定義ができる\u003c/li\u003e\n\u003cli\u003eivar や メソッドの型定義も直観的\u003c/li\u003e\n\u003cli\u003e型付けできないものは \u003ccode\u003euntyped\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eプリミティブな型\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eInteger\u003c/li\u003e\n\u003cli\u003eString\u003c/li\u003e\n\u003cli\u003eHash[Symbol, String]\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eRecord type\u003c/code\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eHash の型を指定\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e{ id: Integer, name: String }\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eInterface type\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003e例: each メソッドを持っている型\u003c/p\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003einterface _Each\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"token method-definition\"\u003e\u003cspan class=\"token function\"\u003eeach\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e void \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eLiteral type\u003c/code\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e型の取り得る値を限定できる\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e1\u003c/code\u003e という型は Integer かつ 値を \u003ccode\u003e1\u003c/code\u003e に限定\u003c/li\u003e\n\u003cli\u003e\"hello world\"という型や\u003ccode\u003e:to_s\u003c/code\u003eという型を定義可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eUnion type\u003c/code\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e型の和を表わす\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInteger | String\u003c/code\u003e は Integer or String\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eIntersection type\u003c/code\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e交差型\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInteger \u0026#x26; String\u003c/code\u003e は Integer and String\u003c/li\u003e\n\u003cli\u003eHash の合成が主な用途？\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e{ id: Integer } \u0026#x26; { name: String }\u003c/code\u003e は \u003ccode\u003e{ id: Integer, name: String }\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e\u003ccode\u003eOptional type\u003c/code\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eみんな大好き null 安全\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInteger?\u003c/code\u003e で \u003ccode\u003eInteger | nil\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eivar やメソッドの型定義\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e@name: String\u003c/code\u003e で ivar\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edef to_s: () -\u003e String\u003c/code\u003e でメソッドを定義\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003e所見\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eTypeScript の影響が強い\n\u003cul\u003e\n\u003cli\u003eLiteral type\u003c/li\u003e\n\u003cli\u003eIntersection type\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eInterface type があればダックタイプもやりやすそう\u003c/li\u003e\n\u003cli\u003e想像していたよりもリッチ\u003c/li\u003e\n\u003cli\u003eany じゃなくて untyped なのはわかりやすくていい\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003chr\u003e\n\u003ch2\u003e実例を通して\u003c/h2\u003e\n\u003cp\u003eruby-signature はまだ StandardLibrary の片付けが終わっていないので\n適当なものに型をつけてみる\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eAbbrev モジュール\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eStandardLibrary で最初に表示されている\u003c/li\u003e\n\u003cli\u003emodule_function abbrev 一つだけのモジュールなので簡単\u003c/li\u003e\n\u003cli\u003eまだ ruby-signature で定義されていない\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eAbbrev#abbrev とは\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eabbrev(words, pattern = nil)\u003c/code\u003e\u003c/p\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e'ruby'\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e  {\"ruby\"=\u003e\"ruby\", \"rub\"=\u003e\"ruby\", \"ru\"=\u003e\"ruby\", \"r\"=\u003e\"ruby\"}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{ car cone }\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {\"ca\"=\u003e\"car\", \"con\"=\u003e\"cone\", \"co\"=\u003e\"cone\", \"car\"=\u003e\"car\", \"cone\"=\u003e\"cone\"}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{car box cone crab}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token regex-literal\"\u003e\u003cspan class=\"token regex\"\u003e/b/\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {\"box\"=\u003e\"box\", \"bo\"=\u003e\"box\", \"b\"=\u003e\"box\", \"crab\" =\u003e \"crab\"}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{car box cone}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e'ca'\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {\"car\"=\u003e\"car\", \"ca\"=\u003e\"car\"}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eString の配列をうけとり、String を分解して key とし、元の String を value とする Hash を返す\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eまずはシンプルなケース\u003c/h3\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e'ruby'\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e  {\"ruby\"=\u003e\"ruby\", \"rub\"=\u003e\"ruby\", \"ru\"=\u003e\"ruby\", \"r\"=\u003e\"ruby\"}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれに型を付けると\u003c/p\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAbbrev\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"token method-definition\"\u003e\u003cspan class=\"token function\"\u003eself\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eHash\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003edef self?\u003c/code\u003e は module function 用の書き方\n空配列を受け取っても空ハッシュを返すだけなので問題なし。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003e第 2 引数について\u003c/h3\u003e\n\u003cp\u003eexample を見ると String と Regexp を受け取ることを想定しているよう\u003c/p\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{car box cone crab}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token regex-literal\"\u003e\u003cspan class=\"token regex\"\u003e/b/\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {\"box\"=\u003e\"box\", \"bo\"=\u003e\"box\", \"b\"=\u003e\"box\", \"crab\" =\u003e \"crab\"}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{car box cone}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e'ca'\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {\"car\"=\u003e\"car\", \"ca\"=\u003e\"car\"}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eじゃあ Integer とか渡したらエラーになるのかな？\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003e想定していなさそうな型の引数を渡してみる\u003c/h3\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e%w{12345}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eエラーにならないだと…\nこの場合って型はどうつければいいのか。\n実装を abbrev の実装を見てみると\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eabbrev の実装\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eString, Regexp 以外は \u003ccode\u003e!~\u003c/code\u003e を直接使っている\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInteger#!~\u003c/code\u003e は常に true を返す\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"token method-definition\"\u003e\u003cspan class=\"token function\"\u003eabbrev\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewords\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pattern \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e pattern\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eis_a\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    pattern \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token regex-literal\"\u003e\u003cspan class=\"token regex\"\u003e/\\A\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token delimiter punctuation\"\u003e#{\u003c/span\u003e\u003cspan class=\"token content\"\u003e\u003cspan class=\"token builtin\"\u003eRegexp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003equote\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epattern\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token delimiter punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token regex\"\u003e/\u003c/span\u003e\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e# regard as a prefix\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e  words\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eeach\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003eword\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003enext\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e word\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eempty\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    word\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esize\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edownto\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003elen\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      abbrev \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e word\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e..\u003c/span\u003elen\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token keyword\"\u003enext\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e pattern \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e pattern \u003cspan class=\"token operator\"\u003e!~\u003c/span\u003e abbrev\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e  words\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eeach\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003eword\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003enext\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e pattern \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e pattern \u003cspan class=\"token operator\"\u003e!~\u003c/span\u003e word\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    table\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eword\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e word\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  table\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch3\u003eabbrev の第 2 引数は String, Regexp 以外を考慮していない\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eString, Regexp 以外を考慮しておらず、たまたま \u003ccode\u003e{}\u003c/code\u003e を返すようになっているだけに見える\u003c/li\u003e\n\u003cli\u003e実行時にエラーにならない場合はどう型をつければよいのか\n\u003cul\u003e\n\u003cli\u003eInteger or Object を引数に取ることを認める\u003c/li\u003e\n\u003cli\u003eString と Regexp 以外は認めない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eこのような場合にどうすればよいか\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eドキュメントにどう書かれているか\u003c/li\u003e\n\u003cli\u003eエラーでないために困る場合を想定してどう検査してほしいかを考える\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eドキュメント\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe optional pattern parameter is a pattern or a string.\nOnly input strings that match the pattern or start with the string are included in the output hash.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003epattern とは言っているけれど、それが Regexp とは限定していない。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eエラーでないために困る場合を想定してどう検査してほしいかを考える\u003c/h3\u003e\n\u003cp\u003e何かのメソッドの返り値が String や Regexp だと思っていたのに Integer だった場合\u003c/p\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"token method-definition\"\u003e\u003cspan class=\"token function\"\u003esome_method\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eInteger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003epattern \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e some_method\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eAbbrev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string-literal\"\u003e\u003cspan class=\"token string\"\u003e\"12345\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pattern\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e#=\u003e {}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInteger が来てここでエラーにならなくてもその後で不整合がおこる場合に困る。\nここを通るテストがない場合になぜ駄目なのかの調査が必要になる。\nそれよりも型検査で弾いてくれたほうが嬉しい。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003e結果\u003c/h3\u003e\n\u003cpre class=\"language-ruby\"\u003e\u003ccode class=\"language-ruby code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAbbrev\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"token method-definition\"\u003e\u003cspan class=\"token function\"\u003eself\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eabbrev\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eRegexp\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eHash\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e第 2 引数は String, Regexp, nil としました。\nこの定義で ruby-signature に PR を送ってマージされた。\u003c/p\u003e\n\u003chr\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eruby-signature の紹介\u003c/li\u003e\n\u003cli\u003eドキュメントにない場合でもそれっぽく動く場合がある\u003c/li\u003e\n\u003cli\u003eどう動いてほしいかを考えて型をつけないといけない場合がある\u003c/li\u003e\n\u003c/ul\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"feeling-to-type-ruby"},"buildId":"0LF11L4L0UyFQzc9l6CxC","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>