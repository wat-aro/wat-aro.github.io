<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>SICP 5.5.5 翻訳系 | (wat-aro)</title><meta name="title" content="SICP 5.5.5 翻訳系 | (wat-aro)"/><meta name="description" content="&lt;p&gt;&lt;a class=&quot;keyword&quot; href=&quot;http://d.hatena.ne.jp/keyword/scheme&quot;&gt;scheme&lt;/a&gt;の式を&lt;a class=&quot;keyword&quot; href=&quot;http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%BF&quot;&gt;"/><meta property="og:locale" content="ja_jp"/><meta property="og:type" content="article"/><meta property="og:site_name" content="(wat-aro)"/><meta property="og:title" content="SICP 5.5.5 翻訳系 | (wat-aro)"/><meta property="og:image" content="https://wat-aro.dev/og-images/SICP 5.5.5 翻訳系.png"/><meta property="og:url" content="https://wat-aro.dev/posts/SICP%205.5.5%20%E7%BF%BB%E8%A8%B3%E7%B3%BB"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@wat_aro"/><meta name="twitter:creator" content="@wat_aro"/><meta name="twitter:title" content="SICP 5.5.5 翻訳系 | (wat-aro)"/><meta name="twitter:description" content="&lt;p&gt;&lt;a class=&quot;keyword&quot; href=&quot;http://d.hatena.ne.jp/keyword/scheme&quot;&gt;scheme&lt;/a&gt;の式を&lt;a class=&quot;keyword&quot; href=&quot;http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%BF&quot;&gt;"/><meta name="twitter:image" content="https://wat-aro.dev/og-images/SICP 5.5.5 翻訳系.png"/><meta name="next-head-count" content="17"/><link rel="icon" href="/images/favicon.ico"/><link rel="preload" href="/_next/static/css/7c83ce157486acf1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7c83ce157486acf1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f557e2d34bba2226.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-ea8a74e177d104de.js" defer=""></script><script src="/_next/static/vDqnfS-2Qy9jo2afqVhBT/_buildManifest.js" defer=""></script><script src="/_next/static/vDqnfS-2Qy9jo2afqVhBT/_ssgManifest.js" defer=""></script><script src="/_next/static/vDqnfS-2Qy9jo2afqVhBT/_middlewareManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MW6D56L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><div class="py-0 md:px-8 min-h-screen flex flex-col items-center"><div class="top-0 bg-white w-full h-16 flex flex-row justify-between items-center px-4 border-b-2"><a href="/"><div class="flex items-center font-midium text-3xl h-full font-bold gap-4"><img class="rounded-full" src="/images/profile.jpg" width="48" height="48" alt="profile image"/>(wat-aro)<!-- --></div></a><ul class="flex gap-3 h-full"><li class="h-full  flex flex-col justify-end border-black pb-4"><a href="/about">About</a></li><li class="h-full  flex flex-col justify-end border-black pb-3 border-b-4"><a href="/posts/pages/1">Blog</a></li></ul></div><div class="flex md:justify-center justify-between w-full"><div class="flex flex-col sm:max-w-sm md:max-w-4xl w-full py-4 px-4"><article class="flex max-w-4xl w-full"><div class="py-4 w-full"><div class="mr-2 text-xs font-bold">2016/02/08</div><h1 class="font-bold text-3xl text-black">SICP 5.5.5 翻訳系</h1><nav class="flex mt-2 mb-2 items-start text-gray-500 text-xs"><div class="flex flex-nowrap max-w-full overflow-x-auto"><p class="mr-1 rounded-full px-2 py-1 border leading-none">scheme</p><p class="mr-1 rounded-full px-2 py-1 border leading-none">SICP</p></div></nav><div class="znc"><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/scheme">scheme</a>の式を<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%BF">レジスタ</a>マシンのシミュレータの命令列に翻訳するコード．<br>
理解するためにコメントを出来るだけつけた</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink=""><code class="code-highlight"><span class="code-line"><span class="synSpecial">(</span><span class="synIdentifier">load</span> <span class="synConstant">"./eval.scm"</span><span class="synSpecial">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; make-branchのための手続き</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> label-counter <span class="synConstant">0</span><span class="synSpecial">)</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>new-label-number<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">set!</span> label-counter <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synConstant">1</span> label-counter<span class="synSpecial">))</span>
</span><span class="code-line">  label-counter<span class="synSpecial">)</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-label name<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">string->symbol</span>
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synIdentifier">string-append</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol->string</span> name<span class="synSpecial">)</span>
</span><span class="code-line">                  <span class="synSpecial">(</span><span class="synIdentifier">number->string</span> <span class="synSpecial">(</span>new-label-number<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; make-compileに必要な機械演算</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-compiled-procedure entry env<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">list</span> <span class="synSpecial">'</span>compiled-procedure entry env<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compiled-procedure? proc<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>tagged-list? proc <span class="synSpecial">'</span>compiled-procedure<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compiled-procedure-entry c-proc<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> c-proc<span class="synSpecial">))</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compiled-procedure-env c-proc<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">caddr</span> c-proc<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> all-regs <span class="synSpecial">'(</span>env proc val argl continue<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span>self-evaluating? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-self-evaluating <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>quoted? <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>compile-quoted <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>variable? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-variable <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>assignment? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-assignment <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>definition? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-definition <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>if? <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>compile-if <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>lambda? <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>compile-lambda <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>begin? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-sequence <span class="synSpecial">(</span>begin-actions <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">                           target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>cond? <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>cond->if <span class="synIdentifier">exp</span><span class="synSpecial">)</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">((</span>application? <span class="synIdentifier">exp</span><span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-application <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span>
</span><span class="code-line">         <span class="synSpecial">(</span>error <span class="synConstant">"Unknown expression type -- COMPILE"</span> <span class="synIdentifier">exp</span><span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-instruction-sequence needs modifies statements<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">list</span> needs modifies statements<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>empty-instruction-sequence<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'()</span> <span class="synSpecial">'()</span> <span class="synSpecial">'()))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 接続コードの翻訳</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-linkage linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>return<span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'(</span>continue<span class="synSpecial">)</span> <span class="synSpecial">'()</span>
</span><span class="code-line">                                    <span class="synSpecial">'((</span>goto <span class="synSpecial">(</span>reg continue<span class="synSpecial">)))))</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>next<span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">(</span>empty-instruction-sequence<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span>
</span><span class="code-line">         <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'()</span> <span class="synSpecial">'()</span>
</span><span class="code-line">                                    <span class="synSpecial">`((</span>goto <span class="synSpecial">(</span>label <span class="synSpecial">,</span>linkage<span class="synSpecial">)))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 命令の最後に次の計算の行き先を入れる．</span>
</span><span class="code-line"><span class="synComment">;;; preservingがあるのでlinkageがreturnでinstruction-sequenceでcontinueを変更しても</span>
</span><span class="code-line"><span class="synComment">;;; save, restoreされるので問題ない</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>end-with-linkage linkage instruction-sequence<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>preserving <span class="synSpecial">'(</span>continue<span class="synSpecial">)</span>
</span><span class="code-line">              instruction-sequence
</span><span class="code-line">              <span class="synSpecial">(</span>compile-linkage linkage<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 単純な式のコンパイル</span>
</span><span class="code-line"><span class="synComment">;;; targetにexpを代入して次の計算への命令を作る</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-self-evaluating <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">   linkage
</span><span class="code-line">   <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'()</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">                              <span class="synSpecial">`((</span>assign <span class="synSpecial">,</span>target <span class="synSpecial">(</span>const <span class="synSpecial">,</span>exp<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; targetに(cadr exp)を代入して次の計算への命令を作る</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-quoted <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">   linkage
</span><span class="code-line">   <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'()</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">                              <span class="synSpecial">`((</span>assign <span class="synSpecial">,</span>target <span class="synSpecial">(</span>const <span class="synSpecial">,(</span>text-of-quotation <span class="synIdentifier">exp</span><span class="synSpecial">)))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; variableを環境から探してきて，見つかった値をtargetに代入して，次の計算への命令を足して返す</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-variable <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">   linkage
</span><span class="code-line">   <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'(</span>env<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">                              <span class="synSpecial">`((</span>assign <span class="synSpecial">,</span>target
</span><span class="code-line">                                        <span class="synSpecial">(</span>op lookup-variable-value<span class="synSpecial">)</span>
</span><span class="code-line">                                        <span class="synSpecial">(</span>const <span class="synSpecial">,</span>exp<span class="synSpecial">)</span>
</span><span class="code-line">                                        <span class="synSpecial">(</span>reg env<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 代入</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-assignment <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>var <span class="synSpecial">(</span>assignment-variable <span class="synIdentifier">exp</span><span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>get-value-code                 <span class="synComment">;valを求めるための命令．</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>assignment-value <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>val <span class="synSpecial">'</span>next<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">     linkage
</span><span class="code-line">     <span class="synSpecial">(</span>preserving <span class="synSpecial">'(</span>env<span class="synSpecial">)</span>                 <span class="synComment">;valを求める間に環境が変わると困る</span>
</span><span class="code-line">                 get-value-code         <span class="synComment">;代入する値を求め，valに代入される．seq1</span>
</span><span class="code-line">                 <span class="synComment">;; valに代入された値をvarに代入する．seq2</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">                  <span class="synComment">;;  ;代入するので元々の環境と代入する値を必要とする．</span>
</span><span class="code-line">                  <span class="synSpecial">'(</span>env val<span class="synSpecial">)</span>
</span><span class="code-line">                  <span class="synComment">;; targetに'okを入れて返すのでtargetは変更する</span>
</span><span class="code-line">                  <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">                  <span class="synSpecial">`((</span>perform <span class="synSpecial">(</span>op set-variable-value!<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>const <span class="synSpecial">,</span>var<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>reg val<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>reg env<span class="synSpecial">))</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>assign <span class="synSpecial">,</span>target <span class="synSpecial">(</span>const ok<span class="synSpecial">))))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 定義</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-definition <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>var <span class="synSpecial">(</span>definition-variable <span class="synIdentifier">exp</span><span class="synSpecial">))</span> <span class="synComment">;糖衣構文(f x)の場合でもfがvarに束縛される</span>
</span><span class="code-line">        <span class="synSpecial">(</span>get-value-code                 <span class="synComment">;varに束縛する値を求める命令</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>definition-value <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>val <span class="synSpecial">'</span>next<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">     linkage
</span><span class="code-line">     <span class="synSpecial">(</span>preserving <span class="synSpecial">'(</span>env<span class="synSpecial">)</span>                 <span class="synComment">;valを求める間に環境が変わると困る</span>
</span><span class="code-line">                 get-value-code
</span><span class="code-line">                 <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">                  <span class="synComment">;;定義する元々の環境とget-value-codeで求めた値の入っているvalが必要</span>
</span><span class="code-line">                  <span class="synSpecial">'(</span>env val<span class="synSpecial">)</span>
</span><span class="code-line">                  <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>         <span class="synComment">;targetにokを入れて返す</span>
</span><span class="code-line">                  <span class="synSpecial">`((</span>perform <span class="synSpecial">(</span>op define-variable!<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>const <span class="synSpecial">,</span>var<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>reg val<span class="synSpecial">)</span>
</span><span class="code-line">                             <span class="synSpecial">(</span>reg env<span class="synSpecial">))</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>assign <span class="synSpecial">,</span>target <span class="synSpecial">(</span>const ok<span class="synSpecial">))))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 条件式</span>
</span><span class="code-line"><span class="synComment">;;; ifはtestがtrueならfalseに飛ぶ．</span>
</span><span class="code-line"><span class="synComment">;;; そのためlinkageがnextの場合，そのままだとtrueの後にfalseにいってしまう</span>
</span><span class="code-line"><span class="synComment">;;; falseを飛ばすためにtrueの後はafter-ifに飛ぶように</span>
</span><span class="code-line"><span class="synComment">;;; nextの場合はconsequenct-linkageにafter-ifを入れる．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-if <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synComment">;; make-branchで書くラベルにIDをつける</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>t-branch <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>true-branch<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>f-branch <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>false-branch<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>after-if <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>after-if<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>consequent-linkage           <span class="synComment">;nextならafter-ifが入る</span>
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>next<span class="synSpecial">)</span> after-if linkage<span class="synSpecial">)))</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>p-code <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>if-predicate <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>val <span class="synSpecial">'</span>next<span class="synSpecial">))</span> <span class="synComment">;術後を生成する</span>
</span><span class="code-line">            <span class="synSpecial">(</span>c-code
</span><span class="code-line">             <span class="synSpecial">(</span>compile
</span><span class="code-line">              <span class="synSpecial">(</span>if-consequent <span class="synIdentifier">exp</span><span class="synSpecial">)</span> target consequent-linkage<span class="synSpecial">))</span> <span class="synComment">;consequenct節の命令の生成</span>
</span><span class="code-line">            <span class="synSpecial">(</span>a-code
</span><span class="code-line">             <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>if-alternative <span class="synIdentifier">exp</span><span class="synSpecial">)</span> target linkage<span class="synSpecial">)))</span> <span class="synComment">;alterenative節の命令の生成</span>
</span><span class="code-line">        <span class="synSpecial">(</span>preserving <span class="synSpecial">'(</span>env continue<span class="synSpecial">)</span>     <span class="synComment">;環境とcontinueは保護</span>
</span><span class="code-line">                    p-code
</span><span class="code-line">                    <span class="synSpecial">(</span>append-instruction-sequences <span class="synComment">;任意の数の式をつながりのある式として連結する</span>
</span><span class="code-line">                     <span class="synSpecial">(</span>make-instruction-sequence <span class="synSpecial">'(</span>val<span class="synSpecial">)</span> <span class="synSpecial">'()</span>
</span><span class="code-line">                                                <span class="synSpecial">`((</span>test <span class="synSpecial">(</span>op false?<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg val<span class="synSpecial">))</span>
</span><span class="code-line">                                                  <span class="synSpecial">(</span>branch <span class="synSpecial">(</span>label <span class="synSpecial">,</span>f-branch<span class="synSpecial">))))</span>
</span><span class="code-line">                     <span class="synComment">;; prallelで逐次実行でなくどちらかだけが実行される命令を作る</span>
</span><span class="code-line">                     <span class="synComment">;; これはどちらが選ばれるか実行時までわからないので</span>
</span><span class="code-line">                     <span class="synComment">;; neededとmodifiedの和集合をとる．</span>
</span><span class="code-line">                     <span class="synSpecial">(</span>parallel-instruction-sequences
</span><span class="code-line">                      <span class="synSpecial">(</span>append-instruction-sequences t-branch c-code<span class="synSpecial">)</span>
</span><span class="code-line">                      <span class="synSpecial">(</span>append-instruction-sequences f-branch a-code<span class="synSpecial">))</span>
</span><span class="code-line">                     after-if<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 並び</span>
</span><span class="code-line"><span class="synComment">;;; beginやlambdaのbodyで使う</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-sequence seq target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>last-exp? seq<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>first-exp seq<span class="synSpecial">)</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>preserving
</span><span class="code-line">       <span class="synSpecial">'(</span>env continue<span class="synSpecial">)</span>                  <span class="synComment">;環境と継続は保護</span>
</span><span class="code-line">       <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>first-exp seq<span class="synSpecial">)</span> target <span class="synSpecial">'</span>next<span class="synSpecial">)</span> <span class="synComment">;そのまま次の命令を実行するのでnext</span>
</span><span class="code-line">       <span class="synSpecial">(</span>compile-sequence <span class="synSpecial">(</span>rest-exps seq<span class="synSpecial">)</span> target linkage<span class="synSpecial">))))</span> <span class="synComment">;再帰的に命令列を作る</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; lambda式</span>
</span><span class="code-line"><span class="synComment">;;; target(val)にコンパイルした式のラベルを束縛してlambda-linkageにジャンプ</span>
</span><span class="code-line"><span class="synComment">;;; 実際に式を呼び出すときにcompile-lambda-bodyで作るラベルにジャンプし，処理をする</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-lambda <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>proc-entry <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>entry<span class="synSpecial">))</span> <span class="synComment">;コンパイルされた式はこのentry-idのラベルで処理される</span>
</span><span class="code-line">        <span class="synSpecial">(</span>after-lambda <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>after-lambda<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>lambda-linkage
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>next<span class="synSpecial">)</span> after-lambda linkage<span class="synSpecial">)))</span>
</span><span class="code-line">      <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">       <span class="synComment">;; tack-onでend-with-linkageにcompile-lambda-bodyを連結．</span>
</span><span class="code-line">       <span class="synComment">;; neededとmodifiedはend-with-linkageのほうを使う</span>
</span><span class="code-line">       <span class="synSpecial">(</span>tack-on-instruction-sequence
</span><span class="code-line">        <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">         lambda-linkage
</span><span class="code-line">         <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">          <span class="synSpecial">'(</span>env<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">          <span class="synSpecial">`((</span>assign <span class="synSpecial">,</span>target
</span><span class="code-line">                    <span class="synSpecial">(</span>op make-compiled-procedure<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>label <span class="synSpecial">,</span>proc-entry<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>reg env<span class="synSpecial">)))))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>compile-lambda-body <span class="synIdentifier">exp</span> proc-entry<span class="synSpecial">))</span>
</span><span class="code-line">       after-lambda<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; コンパイルした手続きが実際に処理をするラベルの中身を作る</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-lambda-body <span class="synIdentifier">exp</span> proc-entry<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>formals <span class="synSpecial">(</span>lambda-parameters <span class="synIdentifier">exp</span><span class="synSpecial">)))</span> <span class="synComment">;lambdaの引数はformalsに束縛</span>
</span><span class="code-line">    <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">     <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">      <span class="synSpecial">'(</span>env proc argl<span class="synSpecial">)</span> <span class="synSpecial">'(</span>env<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synComment">;; 実際の処理をするラベル</span>
</span><span class="code-line">      <span class="synSpecial">`(,</span>proc-entry
</span><span class="code-line">        <span class="synSpecial">(</span>assign env <span class="synSpecial">(</span>op compiled-procedure-env<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg proc<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>assign env                     <span class="synComment">;ここで仮引数と実引数で環境を拡張</span>
</span><span class="code-line">                <span class="synSpecial">(</span>op extend-environment<span class="synSpecial">)</span>
</span><span class="code-line">                <span class="synSpecial">(</span>const <span class="synSpecial">,</span>formals<span class="synSpecial">)</span>
</span><span class="code-line">                <span class="synSpecial">(</span>reg argl<span class="synSpecial">)</span>
</span><span class="code-line">                <span class="synSpecial">(</span>reg env<span class="synSpecial">))))</span>
</span><span class="code-line">     <span class="synComment">;; lambdaのbodyは式が複数のことがあるのでcompile-sequence</span>
</span><span class="code-line">     <span class="synComment">;; 呼び出し元に値を返さないと行けないのでlinkageはreturn</span>
</span><span class="code-line">     <span class="synSpecial">(</span>compile-sequence <span class="synSpecial">(</span>lambda-body <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>val <span class="synSpecial">'</span>return<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; apply</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-application <span class="synIdentifier">exp</span> target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">(</span>
</span><span class="code-line">        <span class="synComment">;; operatorをコンパイルしたら次はoperandの評価をしなければいけないのでnext</span>
</span><span class="code-line">        <span class="synSpecial">(</span>proc-code <span class="synSpecial">(</span>compile <span class="synSpecial">(</span>operator <span class="synIdentifier">exp</span><span class="synSpecial">)</span> <span class="synSpecial">'</span>proc <span class="synSpecial">'</span>next<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synComment">;; operandは複数なのでそれぞれcompileしてリストにして保持</span>
</span><span class="code-line">        <span class="synSpecial">(</span>operand-codes
</span><span class="code-line">         <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>operand<span class="synSpecial">)</span> <span class="synSpecial">(</span>compile operand <span class="synSpecial">'</span>val <span class="synSpecial">'</span>next<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synSpecial">(</span>operands <span class="synIdentifier">exp</span><span class="synSpecial">))))</span>
</span><span class="code-line">    <span class="synSpecial">(</span>preserving
</span><span class="code-line">     <span class="synSpecial">'(</span>env continue<span class="synSpecial">)</span>
</span><span class="code-line">     proc-code                          <span class="synComment">;最初にoperatorを確定させる</span>
</span><span class="code-line">     <span class="synSpecial">(</span>preserving
</span><span class="code-line">      <span class="synSpecial">'(</span>proc continue<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>construct-arglist operand-codes<span class="synSpecial">)</span> <span class="synComment">;operandを評価してarglに代入するための命令の生成</span>
</span><span class="code-line">      <span class="synSpecial">(</span>compile-procedure-call target linkage<span class="synSpecial">)))))</span> <span class="synComment">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; compile-applicationでoperand-codesはコンパイル済みなのでそれをarglに入れるための命令を生成</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>construct-arglist operand-codes<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synComment">;; reverseして連結していくので右から左に評価することになる</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>operand-codes <span class="synSpecial">(</span><span class="synIdentifier">reverse</span> operand-codes<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> operand-codes<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synComment">;; 引数がない場合はarglに'()を代入</span>
</span><span class="code-line">        <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">         <span class="synSpecial">'()</span> <span class="synSpecial">'(</span>argl<span class="synSpecial">)</span>
</span><span class="code-line">         <span class="synSpecial">`((</span>assign argl <span class="synSpecial">(</span>const <span class="synSpecial">()))))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>code-to-get-last-arg     <span class="synComment">;最後のoperandが生成する命令</span>
</span><span class="code-line">               <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">                <span class="synSpecial">(</span><span class="synIdentifier">car</span> operand-codes<span class="synSpecial">)</span>
</span><span class="code-line">                <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">                 <span class="synSpecial">'(</span>val<span class="synSpecial">)</span> <span class="synSpecial">'(</span>argl<span class="synSpecial">)</span>         <span class="synComment">;arglの初期化が必要なのでこれだけ特別に処理</span>
</span><span class="code-line">                 <span class="synSpecial">`((</span>assign argl <span class="synSpecial">(</span>op list<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg val<span class="synSpecial">)))))))</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> operand-codes<span class="synSpecial">))</span>
</span><span class="code-line">              code-to-get-last-arg      <span class="synComment">;cdrがnullなら最後のoperand</span>
</span><span class="code-line">              <span class="synComment">;; まだoperandが残っていればこちら</span>
</span><span class="code-line">              <span class="synSpecial">(</span>preserving
</span><span class="code-line">               <span class="synSpecial">'(</span>env<span class="synSpecial">)</span>                   <span class="synComment">;環境は保持</span>
</span><span class="code-line">               code-to-get-last-arg     <span class="synComment">;引数の最後（reverseしているので先頭）からつなげる.</span>
</span><span class="code-line">               <span class="synSpecial">(</span>code-to-get-rest-args
</span><span class="code-line">                <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> operand-codes<span class="synSpecial">))))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; last-arg以外はここで処理する</span>
</span><span class="code-line"><span class="synComment">;;; operand-codesはコンパイル済み</span>
</span><span class="code-line"><span class="synComment">;;; arglには既に最後の引数が代入されているのでそこに先頭(reverseしてるので後ろ)から代入していく</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>code-to-get-rest-args operand-codes<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>code-for-next-arg              <span class="synComment">;先頭</span>
</span><span class="code-line">         <span class="synSpecial">(</span>preserving
</span><span class="code-line">          <span class="synSpecial">'(</span>argl<span class="synSpecial">)</span>
</span><span class="code-line">          <span class="synSpecial">(</span><span class="synIdentifier">car</span> operand-codes<span class="synSpecial">)</span>           <span class="synComment">;valに先頭の要素のコンパイル結果を代入する命令</span>
</span><span class="code-line">          <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">           <span class="synSpecial">'(</span>val argl<span class="synSpecial">)</span> <span class="synSpecial">'(</span>argl<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">'((</span>assign argl               <span class="synComment">;valに入った(car operand)の値をarglに代入</span>
</span><span class="code-line">                     <span class="synSpecial">(</span>op cons<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg val<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg argl<span class="synSpecial">)))))))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> operand-codes<span class="synSpecial">))</span>
</span><span class="code-line">        code-for-next-arg
</span><span class="code-line">        <span class="synSpecial">(</span>preserving
</span><span class="code-line">         <span class="synSpecial">'(</span>env<span class="synSpecial">)</span>
</span><span class="code-line">         code-for-next-arg
</span><span class="code-line">         <span class="synSpecial">(</span>code-to-get-rest-args <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> operand-cods<span class="synSpecial">))))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; operator, operandsを評価する命令を作った後に呼ばれる</span>
</span><span class="code-line"><span class="synComment">;;; この時点でprocにはoperatorのシンボル, arglにはoperandsが入っている</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-procedure-call target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>primitive-branch <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>primitive-branch<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>compiled-branch <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>compiled-branch<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>after-call <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>after-call<span class="synSpecial">)))</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>compiled-linkage
</span><span class="code-line">           <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>next<span class="synSpecial">)</span> after-call linkage<span class="synSpecial">)))</span>
</span><span class="code-line">      <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">       <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">        <span class="synSpecial">'(</span>proc<span class="synSpecial">)</span> <span class="synSpecial">'()</span>
</span><span class="code-line">        <span class="synSpecial">`((</span>test <span class="synSpecial">(</span>op primitive-procedure?<span class="synSpecial">)</span> <span class="synSpecial">(</span>reg proc<span class="synSpecial">))</span>
</span><span class="code-line">          <span class="synSpecial">(</span>branch <span class="synSpecial">(</span>label <span class="synSpecial">,</span>primitive-branch<span class="synSpecial">))))</span>
</span><span class="code-line">       <span class="synComment">;; compiled-branchかprimitive-branchのどちらかだけが実行されるのでparallel</span>
</span><span class="code-line">       <span class="synSpecial">(</span>parallel-instruction-sequences
</span><span class="code-line">        <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">         compiled-branch
</span><span class="code-line">         <span class="synComment">;; ここでtargetとlinkageに合わせた命令を生成</span>
</span><span class="code-line">         <span class="synSpecial">(</span>compile-proc-appl target compiled-linkage<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span>append-instruction-sequences
</span><span class="code-line">         primitive-branch
</span><span class="code-line">         <span class="synSpecial">(</span>end-with-linkage
</span><span class="code-line">          linkage
</span><span class="code-line">          <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">           <span class="synSpecial">'(</span>proc argl<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> target<span class="synSpecial">)</span>
</span><span class="code-line">           <span class="synSpecial">`((</span>assign <span class="synSpecial">,</span>target
</span><span class="code-line">                     <span class="synSpecial">(</span>op apply-primitive-procedure<span class="synSpecial">)</span>
</span><span class="code-line">                     <span class="synSpecial">(</span>reg proc<span class="synSpecial">)</span>
</span><span class="code-line">                     <span class="synSpecial">(</span>reg argl<span class="synSpecial">)))))))</span>
</span><span class="code-line">       after-call<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 手続きの採用</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>compile-proc-appl target linkage<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">(</span>
</span><span class="code-line">         <span class="synComment">;; linkageがreturnでなければlinkageにはいったlabelが値を返す場所</span>
</span><span class="code-line">         <span class="synSpecial">(</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> target <span class="synSpecial">'</span>val<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">not</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>return<span class="synSpecial">)))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">          <span class="synSpecial">'(</span>proc<span class="synSpecial">)</span> all-regs
</span><span class="code-line">          <span class="synSpecial">`((</span>assign continue <span class="synSpecial">(</span>label <span class="synSpecial">,</span>linkage<span class="synSpecial">))</span> <span class="synComment">;計算した値をvalに入れたらこのlinkageにジャンプ</span>
</span><span class="code-line">            <span class="synSpecial">(</span>assign val <span class="synSpecial">(</span>op compiled-procedure-entry<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>reg proc<span class="synSpecial">))</span>
</span><span class="code-line">            <span class="synSpecial">(</span>goto <span class="synSpecial">(</span>reg val<span class="synSpecial">)))))</span>
</span><span class="code-line">        <span class="synComment">;; targetがvalでないのでproc-returnでtargetにvalを代入しないといけない</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">not</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> target <span class="synSpecial">'</span>val<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synSpecial">(</span><span class="synIdentifier">not</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>return<span class="synSpecial">)))</span>
</span><span class="code-line">         <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>proc-return <span class="synSpecial">(</span>make-label <span class="synSpecial">'</span>proc-return<span class="synSpecial">)))</span>
</span><span class="code-line">           <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">            <span class="synSpecial">'(</span>proc<span class="synSpecial">)</span> all-regs
</span><span class="code-line">            <span class="synSpecial">`((</span>assign continue <span class="synSpecial">(</span>label <span class="synSpecial">,</span>proc-return<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synSpecial">(</span>assign val <span class="synSpecial">(</span>op compiled-procedure-entry<span class="synSpecial">)</span>
</span><span class="code-line">                      <span class="synSpecial">(</span>reg proc<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synSpecial">(</span>goto <span class="synSpecial">(</span>reg val<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synSpecial">,</span>proc-return
</span><span class="code-line">              <span class="synSpecial">(</span>assign <span class="synSpecial">,</span>target <span class="synSpecial">(</span>reg val<span class="synSpecial">))</span> <span class="synComment">;targetがvalでないので，ここでtargetにvalを代入</span>
</span><span class="code-line">              <span class="synSpecial">(</span>goto <span class="synSpecial">(</span>label <span class="synSpecial">,</span>linkage<span class="synSpecial">))))))</span>
</span><span class="code-line">        <span class="synComment">;; targetがvalでreturnなら計算の後，continueに行けばいいので余計な処理はない</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> target <span class="synSpecial">'</span>val<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>return<span class="synSpecial">))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">          <span class="synSpecial">'(</span>proc continue<span class="synSpecial">)</span> all-regs
</span><span class="code-line">          <span class="synSpecial">`((</span>assign val <span class="synSpecial">(</span>op compiled-procedure-entry<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>reg proc<span class="synSpecial">))</span>
</span><span class="code-line">            <span class="synSpecial">(</span>goto <span class="synSpecial">(</span>reg val<span class="synSpecial">)))))</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">not</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> target <span class="synSpecial">'</span>val<span class="synSpecial">))</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> linkage <span class="synSpecial">'</span>return<span class="synSpecial">))</span>
</span><span class="code-line">         <span class="synSpecial">(</span>error <span class="synConstant">"return linkage, target not val -- COMPILE"</span> target<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 命令列の組み合わせ</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>registers-needed s<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol?</span> s<span class="synSpecial">)</span> <span class="synSpecial">'()</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> s<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>registers-modified s<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol?</span> s<span class="synSpecial">)</span> <span class="synSpecial">'()</span> <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> s<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>statements s<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol?</span> s<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> s<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">caddr</span> s<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>needs-register? seq reg<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">memq</span> reg <span class="synSpecial">(</span>registers-needed seq<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>modifies-register? seq reg<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synIdentifier">memq</span> reg <span class="synSpecial">(</span>registers-modified seq<span class="synSpecial">)))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; neededとmodifiedをうまく合成して新しい命令列を作る</span>
</span><span class="code-line"><span class="synComment">;;; これは人つながりの命令にする．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>append-instruction-sequences <span class="synSpecial">.</span> seqs<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>append-2-sequences seq1 seq2<span class="synSpecial">)</span>
</span><span class="code-line">    <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">     <span class="synComment">;; needed</span>
</span><span class="code-line">     <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span>registers-needed seq1<span class="synSpecial">)</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>list-difference <span class="synSpecial">(</span>registers-needed seq2<span class="synSpecial">)</span> <span class="synComment">;seq1で変更してseq2がそれを必要とする</span>
</span><span class="code-line">                                  <span class="synSpecial">(</span>registers-modified seq1<span class="synSpecial">)))</span> <span class="synComment">;ならseq1の時点では必要ない</span>
</span><span class="code-line">     <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span>registers-modified seq1<span class="synSpecial">)</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>registers-modified seq2<span class="synSpecial">))</span>
</span><span class="code-line">     <span class="synSpecial">(</span><span class="synIdentifier">append</span> <span class="synSpecial">(</span>statements seq1<span class="synSpecial">)</span> <span class="synSpecial">(</span>statements seq2<span class="synSpecial">))))</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>append-seq-list seqs<span class="synSpecial">)</span>
</span><span class="code-line">    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> seqs<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">(</span>empty-instruction-sequence<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">(</span>append-2-sequences <span class="synSpecial">(</span><span class="synIdentifier">car</span> seqs<span class="synSpecial">)</span>  <span class="synComment">;nullじゃなければこっち．</span>
</span><span class="code-line">                            <span class="synSpecial">(</span>append-seq-list <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> seqs<span class="synSpecial">)))))</span>
</span><span class="code-line">  <span class="synSpecial">(</span>append-seq-list seqs<span class="synSpecial">))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; 集合演算</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>list-union s1 s2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">null?</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">)</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">memq</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">)</span> <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> s1<span class="synSpecial">)</span> <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>list-difference s1 s2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">cond</span> <span class="synSpecial">((</span><span class="synIdentifier">null?</span> s1<span class="synSpecial">)</span> <span class="synSpecial">'())</span>
</span><span class="code-line">        <span class="synSpecial">((</span><span class="synIdentifier">memq</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">)</span> <span class="synSpecial">(</span>list-difference <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">))</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> s1<span class="synSpecial">)</span>
</span><span class="code-line">                    <span class="synSpecial">(</span>list-difference <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> s1<span class="synSpecial">)</span> s2<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; regsの中にseq1で変更してseq2でしようするレジスタがあれば</span>
</span><span class="code-line"><span class="synComment">;;; seq1の前後でsave, restoreする命令を作る．</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>preserving regs seq1 seq2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> regs<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span>append-instruction-sequences seq1 seq2<span class="synSpecial">)</span>
</span><span class="code-line">      <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>first-reg <span class="synSpecial">(</span><span class="synIdentifier">car</span> regs<span class="synSpecial">)))</span>     <span class="synComment">;first-regが</span>
</span><span class="code-line">        <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">and</span> <span class="synSpecial">(</span>needs-register? seq2 first-reg<span class="synSpecial">)</span> <span class="synComment">;seq2に必要なレジスタで</span>
</span><span class="code-line">                 <span class="synSpecial">(</span>modifies-register? seq1 first-reg<span class="synSpecial">))</span> <span class="synComment">;seq1が変更するレジスタなら</span>
</span><span class="code-line">            <span class="synSpecial">(</span>preserving
</span><span class="code-line">             <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> regs<span class="synSpecial">)</span>
</span><span class="code-line">             <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">              <span class="synComment">;; needs ここでsaveするのでfirst-regが必要になるのでlist-union</span>
</span><span class="code-line">              <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span><span class="synIdentifier">list</span> first-reg<span class="synSpecial">)</span>
</span><span class="code-line">                          <span class="synSpecial">(</span>registers-needed seq1<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synComment">;; modify saveしてのseq2の前にrestoreするのでseq2から見ればfirst-reg変更無し</span>
</span><span class="code-line">              <span class="synSpecial">(</span>list-difference <span class="synSpecial">(</span>registers-modified seq1<span class="synSpecial">)</span>
</span><span class="code-line">                               <span class="synSpecial">(</span><span class="synIdentifier">list</span> first-reg<span class="synSpecial">))</span>
</span><span class="code-line">              <span class="synComment">;; statements 条件を満たすfirst-regの場合はseq1をsaveとrestoreで挟む</span>
</span><span class="code-line">              <span class="synSpecial">(</span><span class="synIdentifier">append</span> <span class="synSpecial">`((</span>save <span class="synSpecial">,</span>first-reg<span class="synSpecial">))</span>
</span><span class="code-line">                      <span class="synSpecial">(</span>statements seq1<span class="synSpecial">)</span>
</span><span class="code-line">                      <span class="synSpecial">`((</span>restore <span class="synSpecial">,</span>first-reg<span class="synSpecial">))))</span>
</span><span class="code-line">             seq2<span class="synSpecial">)</span>
</span><span class="code-line">            <span class="synSpecial">(</span>preserving <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> regs<span class="synSpecial">)</span> seq1 seq2<span class="synSpecial">)))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; seqとbodyとbody-seqをつなげる．neededとmodifiedはseqのまま</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>tack-on-instruction-sequence seq body-seq<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">   <span class="synSpecial">(</span>registers-needed seq<span class="synSpecial">)</span>
</span><span class="code-line">   <span class="synSpecial">(</span>registers-modified seq<span class="synSpecial">)</span>
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synIdentifier">append</span> <span class="synSpecial">(</span>statements seq<span class="synSpecial">)</span> <span class="synSpecial">(</span>statements body-seq<span class="synSpecial">))))</span>
</span><span class="code-line">
</span><span class="code-line"><span class="synComment">;;; neededとmodifiedは和集合を取る．</span>
</span><span class="code-line"><span class="synComment">;;; ifのconsequentとalternative, や</span>
</span><span class="code-line"><span class="synComment">;;; 手続きのcompiled, primitiveの違いのようにどちらかだけが実行されるようなラベルを作るときに使う</span>
</span><span class="code-line"><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>parallel-instruction-sequences seq1 seq2<span class="synSpecial">)</span>
</span><span class="code-line">  <span class="synSpecial">(</span>make-instruction-sequence
</span><span class="code-line">   <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span>registers-needed seq1<span class="synSpecial">)</span>
</span><span class="code-line">               <span class="synSpecial">(</span>registers-needed seq2<span class="synSpecial">))</span>
</span><span class="code-line">   <span class="synSpecial">(</span>list-union <span class="synSpecial">(</span>registers-modified seq1<span class="synSpecial">)</span>
</span><span class="code-line">               <span class="synSpecial">(</span>registers-modified seq2<span class="synSpecial">))</span>
</span><span class="code-line">   <span class="synSpecial">(</span><span class="synIdentifier">append</span> <span class="synSpecial">(</span>statements seq1<span class="synSpecial">)</span> <span class="synSpecial">(</span>statements seq2<span class="synSpecial">))))</span>
</span></code></pre></div></div></article></div></div><div class="flex md:justify-center w-full"><div class="flex flex-col md:max-w-4xl w-full"><hr/><div class="flex justify-center pt-4 pb-8">© 2022 wat-aro</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"data":{"title":"SICP 5.5.5 翻訳系","published":"2016/02/08","tags":["scheme","SICP"]},"content":"\n\u003cp\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/scheme\"\u003escheme\u003c/a\u003eの式を\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%BF\"\u003eレジスタ\u003c/a\u003eマシンのシミュレータの命令列に翻訳するコード．\u003cbr/\u003e\n理解するためにコメントを出来るだけつけた\u003c/p\u003e\n\n\u003cpre class=\"code lang-scheme\" data-lang=\"scheme\" data-unlink\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eload\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;./eval.scm\u0026quot;\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; make-branchのための手続き\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e label-counter \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-label-number\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e label-counter \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e+\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e label-counter\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n  label-counter\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label name\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u0026gt;symbol\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u0026gt;string\u003c/span\u003e name\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber-\u0026gt;string\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-label-number\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; make-compileに必要な機械演算\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-compiled-procedure entry env\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-procedure entry env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure? proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? proc \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-procedure\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure-entry c-proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e c-proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure-env c-proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e c-proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e all-regs \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv proc val argl continue\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eself-evaluating? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-self-evaluating \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003equoted? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-quoted \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evariable? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eassignment? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-assignment \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003edefinition? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-definition \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eif? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-if \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003elambda? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebegin? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebegin-actions \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                           target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003econd? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econd-\u0026gt;if \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eapplication? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-application \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\u0026quot;Unknown expression type -- COMPILE\u0026quot;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence needs modifies statements\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e needs modifies statements\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 接続コードの翻訳\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-linkage linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003econtinue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n                                    \u003cspan class=\"synSpecial\"\u003e'((\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg continue\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n                                    \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 命令の最後に次の計算の行き先を入れる．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; preservingがあるのでlinkageがreturnでinstruction-sequenceでcontinueを変更しても\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; save, restoreされるので問題ない\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage linkage instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003econtinue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n              instruction-sequence\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-linkage linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 単純な式のコンパイル\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; targetにexpを代入して次の計算への命令を作る\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-self-evaluating \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n   linkage\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eexp\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; targetに(cadr exp)を代入して次の計算への命令を作る\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-quoted \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n   linkage\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,(\u003c/span\u003etext-of-quotation \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; variableを環境から探してきて，見つかった値をtargetに代入して，次の計算への命令を足して返す\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n   linkage\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop lookup-variable-value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eexp\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 代入\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-assignment \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassignment-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-value-code                 \u003cspan class=\"synComment\"\u003e;valを求めるための命令．\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassignment-value \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n     linkage\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                 \u003cspan class=\"synComment\"\u003e;valを求める間に環境が変わると困る\u003c/span\u003e\n                 get-value-code         \u003cspan class=\"synComment\"\u003e;代入する値を求め，valに代入される．seq1\u003c/span\u003e\n                 \u003cspan class=\"synComment\"\u003e;; valに代入された値をvarに代入する．seq2\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n                  \u003cspan class=\"synComment\"\u003e;;  ;代入するので元々の環境と代入する値を必要とする．\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                  \u003cspan class=\"synComment\"\u003e;; targetに'okを入れて返すのでtargetは変更する\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eperform \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop set-variable-value!\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003evar\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst ok\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 定義\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-definition \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edefinition-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;糖衣構文(f x)の場合でもfがvarに束縛される\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-value-code                 \u003cspan class=\"synComment\"\u003e;varに束縛する値を求める命令\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edefinition-value \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n     linkage\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                 \u003cspan class=\"synComment\"\u003e;valを求める間に環境が変わると困る\u003c/span\u003e\n                 get-value-code\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n                  \u003cspan class=\"synComment\"\u003e;;定義する元々の環境とget-value-codeで求めた値の入っているvalが必要\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e         \u003cspan class=\"synComment\"\u003e;targetにokを入れて返す\u003c/span\u003e\n                  \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eperform \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop define-variable!\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003evar\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst ok\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 条件式\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; ifはtestがtrueならfalseに飛ぶ．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; そのためlinkageがnextの場合，そのままだとtrueの後にfalseにいってしまう\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; falseを飛ばすためにtrueの後はafter-ifに飛ぶように\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; nextの場合はconsequenct-linkageにafter-ifを入れる．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-if \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synComment\"\u003e;; make-branchで書くラベルにIDをつける\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003et-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003etrue-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ef-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efalse-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-if \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-if\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003econsequent-linkage           \u003cspan class=\"synComment\"\u003e;nextならafter-ifが入る\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-if linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ep-code \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-predicate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;術後を生成する\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ec-code\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-consequent \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target consequent-linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;consequenct節の命令の生成\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ea-code\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-alternative \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;alterenative節の命令の生成\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;環境とcontinueは保護\u003c/span\u003e\n                    p-code\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences \u003cspan class=\"synComment\"\u003e;任意の数の式をつながりのある式として連結する\u003c/span\u003e\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n                                                \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003etest \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop false?\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                                                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebranch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003ef-branch\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n                     \u003cspan class=\"synComment\"\u003e;; prallelで逐次実行でなくどちらかだけが実行される命令を作る\u003c/span\u003e\n                     \u003cspan class=\"synComment\"\u003e;; これはどちらが選ばれるか実行時までわからないので\u003c/span\u003e\n                     \u003cspan class=\"synComment\"\u003e;; neededとmodifiedの和集合をとる．\u003c/span\u003e\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences t-branch c-code\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences f-branch a-code\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                     after-if\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 並び\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; beginやlambdaのbodyで使う\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence seq target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elast-exp? seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-exp seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n       \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                  \u003cspan class=\"synComment\"\u003e;環境と継続は保護\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-exp seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;そのまま次の命令を実行するのでnext\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-exps seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;再帰的に命令列を作る\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; lambda式\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; target(val)にコンパイルした式のラベルを束縛してlambda-linkageにジャンプ\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; 実際に式を呼び出すときにcompile-lambda-bodyで作るラベルにジャンプし，処理をする\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eproc-entry \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eentry\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;コンパイルされた式はこのentry-idのラベルで処理される\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-lambda \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-lambda\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003elambda-linkage\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-lambda linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n       \u003cspan class=\"synComment\"\u003e;; tack-onでend-with-linkageにcompile-lambda-bodyを連結．\u003c/span\u003e\n       \u003cspan class=\"synComment\"\u003e;; neededとmodifiedはend-with-linkageのほうを使う\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etack-on-instruction-sequence\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n         lambda-linkage\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop make-compiled-procedure\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e proc-entry\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n       after-lambda\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; コンパイルした手続きが実際に処理をするラベルの中身を作る\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e proc-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eformals \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elambda-parameters \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;lambdaの引数はformalsに束縛\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv proc argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synComment\"\u003e;; 実際の処理をするラベル\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e`(,\u003c/span\u003eproc-entry\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign env \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-env\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign env                     \u003cspan class=\"synComment\"\u003e;ここで仮引数と実引数で環境を拡張\u003c/span\u003e\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop extend-environment\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eformals\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n     \u003cspan class=\"synComment\"\u003e;; lambdaのbodyは式が複数のことがあるのでcompile-sequence\u003c/span\u003e\n     \u003cspan class=\"synComment\"\u003e;; 呼び出し元に値を返さないと行けないのでlinkageはreturn\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; apply\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-application \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; operatorをコンパイルしたら次はoperandの評価をしなければいけないのでnext\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eproc-code \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperator \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eproc \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; operandは複数なのでそれぞれcompileしてリストにして保持\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperand-codes\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003emap\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperand\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile operand \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperands \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n     \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n     proc-code                          \u003cspan class=\"synComment\"\u003e;最初にoperatorを確定させる\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstruct-arglist operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;operandを評価してarglに代入するための命令の生成\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-procedure-call target linkage\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; compile-applicationでoperand-codesはコンパイル済みなのでそれをarglに入れるための命令を生成\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstruct-arglist operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synComment\"\u003e;; reverseして連結していくので右から左に評価することになる\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eoperand-codes \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ereverse\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; 引数がない場合はarglに'()を代入\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n         \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign argl \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e()))))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecode-to-get-last-arg     \u003cspan class=\"synComment\"\u003e;最後のoperandが生成する命令\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n                 \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e         \u003cspan class=\"synComment\"\u003e;arglの初期化が必要なのでこれだけ特別に処理\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign argl \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop list\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              code-to-get-last-arg      \u003cspan class=\"synComment\"\u003e;cdrがnullなら最後のoperand\u003c/span\u003e\n              \u003cspan class=\"synComment\"\u003e;; まだoperandが残っていればこちら\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n               \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                   \u003cspan class=\"synComment\"\u003e;環境は保持\u003c/span\u003e\n               code-to-get-last-arg     \u003cspan class=\"synComment\"\u003e;引数の最後（reverseしているので先頭）からつなげる.\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args\n                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; last-arg以外はここで処理する\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; operand-codesはコンパイル済み\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; arglには既に最後の引数が代入されているのでそこに先頭(reverseしてるので後ろ)から代入していく\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecode-for-next-arg              \u003cspan class=\"synComment\"\u003e;先頭\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e           \u003cspan class=\"synComment\"\u003e;valに先頭の要素のコンパイル結果を代入する命令\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n           \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e'((\u003c/span\u003eassign argl               \u003cspan class=\"synComment\"\u003e;valに入った(car operand)の値をarglに代入\u003c/span\u003e\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop cons\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        code-for-next-arg\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n         \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n         code-for-next-arg\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-cods\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; operator, operandsを評価する命令を作った後に呼ばれる\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; この時点でprocにはoperatorのシンボル, arglにはoperandsが入っている\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-procedure-call target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eprimitive-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eprimitive-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-call \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-call\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecompiled-linkage\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-call linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n        \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003etest \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop primitive-procedure?\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebranch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eprimitive-branch\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n       \u003cspan class=\"synComment\"\u003e;; compiled-branchかprimitive-branchのどちらかだけが実行されるのでparallel\u003c/span\u003e\n       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n         compiled-branch\n         \u003cspan class=\"synComment\"\u003e;; ここでtargetとlinkageに合わせた命令を生成\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-proc-appl target compiled-linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n         primitive-branch\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n          linkage\n          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n           \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop apply-primitive-procedure\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n       after-call\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 手続きの採用\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-proc-appl target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\n         \u003cspan class=\"synComment\"\u003e;; linkageがreturnでなければlinkageにはいったlabelが値を返す場所\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign continue \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;計算した値をvalに入れたらこのlinkageにジャンプ\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; targetがvalでないのでproc-returnでtargetにvalを代入しないといけない\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eproc-return \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eproc-return\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n            \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n            \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign continue \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-return\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-return\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;targetがvalでないので，ここでtargetにvalを代入\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n        \u003cspan class=\"synComment\"\u003e;; targetがvalでreturnなら計算の後，continueに行けばいいので余計な処理はない\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\u0026quot;return linkage, target not val -- COMPILE\u0026quot;\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 命令列の組み合わせ\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eneeds-register? seq reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emodifies-register? seq reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; neededとmodifiedをうまく合成して新しい命令列を作る\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; これは人つながりの命令にする．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences \u003cspan class=\"synSpecial\"\u003e.\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-2-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n     \u003cspan class=\"synComment\"\u003e;; needed\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq1で変更してseq2がそれを必要とする\u003c/span\u003e\n                                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;ならseq1の時点では必要ない\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-2-sequences \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e  \u003cspan class=\"synComment\"\u003e;nullじゃなければこっち．\u003c/span\u003e\n                            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list seqs\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; 集合演算\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union s1 s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference s1 s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'())\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; regsの中にseq1で変更してseq2でしようするレジスタがあれば\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; seq1の前後でsave, restoreする命令を作る．\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving regs seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003efirst-reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;first-regが\u003c/span\u003e\n        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eneeds-register? seq2 first-reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq2に必要なレジスタで\u003c/span\u003e\n                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emodifies-register? seq1 first-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq1が変更するレジスタなら\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n              \u003cspan class=\"synComment\"\u003e;; needs ここでsaveするのでfirst-regが必要になるのでlist-union\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e first-reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synComment\"\u003e;; modify saveしてのseq2の前にrestoreするのでseq2から見ればfirst-reg変更無し\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e first-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n              \u003cspan class=\"synComment\"\u003e;; statements 条件を満たすfirst-regの場合はseq1をsaveとrestoreで挟む\u003c/span\u003e\n              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003esave \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003efirst-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n                      \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003erestore \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003efirst-reg\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n             seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e seq1 seq2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; seqとbodyとbody-seqをつなげる．neededとmodifiedはseqのまま\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etack-on-instruction-sequence seq body-seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements body-seq\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e;;; neededとmodifiedは和集合を取る．\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; ifのconsequentとalternative, や\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e;;; 手続きのcompiled, primitiveの違いのようにどちらかだけが実行されるようなラベルを作るときに使う\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/pre\u003e\n\n\n","slug":"SICP 5.5.5 翻訳系"},"content":"\u003cp\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/scheme\"\u003escheme\u003c/a\u003eの式を\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%BF\"\u003eレジスタ\u003c/a\u003eマシンのシミュレータの命令列に翻訳するコード．\u003cbr\u003e\n理解するためにコメントを出来るだけつけた\u003c/p\u003e\n\u003cpre class=\"code lang-scheme\" data-lang=\"scheme\" data-unlink=\"\"\u003e\u003ccode class=\"code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eload\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\"./eval.scm\"\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; make-branchのための手続き\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e label-counter \u003cspan class=\"synConstant\"\u003e0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-label-number\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eset!\u003c/span\u003e label-counter \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e+\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e label-counter\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  label-counter\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label name\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-\u003esymbol\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003estring-append\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol-\u003estring\u003c/span\u003e name\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enumber-\u003estring\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003enew-label-number\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; make-compileに必要な機械演算\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-compiled-procedure entry env\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-procedure entry env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure? proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etagged-list? proc \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-procedure\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure-entry c-proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e c-proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-procedure-env c-proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e c-proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e all-regs \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv proc val argl continue\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eself-evaluating? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-self-evaluating \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003equoted? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-quoted \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evariable? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eassignment? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-assignment \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003edefinition? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-definition \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eif? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-if \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003elambda? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ebegin? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebegin-actions \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                           target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003econd? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econd-\u003eif \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eapplication? \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-application \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\"Unknown expression type -- COMPILE\"\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence needs modifies statements\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e needs modifies statements\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 接続コードの翻訳\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-linkage linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003econtinue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                    \u003cspan class=\"synSpecial\"\u003e'((\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg continue\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                    \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 命令の最後に次の計算の行き先を入れる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; preservingがあるのでlinkageがreturnでinstruction-sequenceでcontinueを変更しても\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; save, restoreされるので問題ない\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage linkage instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003econtinue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-linkage linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 単純な式のコンパイル\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; targetにexpを代入して次の計算への命令を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-self-evaluating \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eexp\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; targetに(cadr exp)を代入して次の計算への命令を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-quoted \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,(\u003c/span\u003etext-of-quotation \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; variableを環境から探してきて，見つかった値をtargetに代入して，次の計算への命令を足して返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                              \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop lookup-variable-value\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eexp\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 代入\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-assignment \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassignment-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-value-code                 \u003cspan class=\"synComment\"\u003e;valを求めるための命令．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassignment-value \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                 \u003cspan class=\"synComment\"\u003e;valを求める間に環境が変わると困る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 get-value-code         \u003cspan class=\"synComment\"\u003e;代入する値を求め，valに代入される．seq1\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synComment\"\u003e;; valに代入された値をvarに代入する．seq2\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synComment\"\u003e;;  ;代入するので元々の環境と代入する値を必要とする．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synComment\"\u003e;; targetに'okを入れて返すのでtargetは変更する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eperform \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop set-variable-value!\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003evar\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst ok\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 定義\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-definition \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003evar \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edefinition-variable \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;糖衣構文(f x)の場合でもfがvarに束縛される\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eget-value-code                 \u003cspan class=\"synComment\"\u003e;varに束縛する値を求める命令\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003edefinition-value \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                 \u003cspan class=\"synComment\"\u003e;valを求める間に環境が変わると困る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 get-value-code\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synComment\"\u003e;;定義する元々の環境とget-value-codeで求めた値の入っているvalが必要\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e         \u003cspan class=\"synComment\"\u003e;targetにokを入れて返す\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                  \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eperform \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop define-variable!\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003evar\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst ok\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 条件式\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; ifはtestがtrueならfalseに飛ぶ．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; そのためlinkageがnextの場合，そのままだとtrueの後にfalseにいってしまう\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; falseを飛ばすためにtrueの後はafter-ifに飛ぶように\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; nextの場合はconsequenct-linkageにafter-ifを入れる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-if \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synComment\"\u003e;; make-branchで書くラベルにIDをつける\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003et-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003etrue-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ef-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003efalse-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-if \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-if\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003econsequent-linkage           \u003cspan class=\"synComment\"\u003e;nextならafter-ifが入る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-if linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ep-code \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-predicate \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;術後を生成する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ec-code\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-consequent \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target consequent-linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;consequenct節の命令の生成\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ea-code\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eif-alternative \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;alterenative節の命令の生成\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;環境とcontinueは保護\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    p-code\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences \u003cspan class=\"synComment\"\u003e;任意の数の式をつながりのある式として連結する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                                \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003etest \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop false?\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebranch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003ef-branch\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synComment\"\u003e;; prallelで逐次実行でなくどちらかだけが実行される命令を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synComment\"\u003e;; これはどちらが選ばれるか実行時までわからないので\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synComment\"\u003e;; neededとmodifiedの和集合をとる．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences t-branch c-code\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences f-branch a-code\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     after-if\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 並び\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; beginやlambdaのbodyで使う\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence seq target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elast-exp? seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-exp seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                  \u003cspan class=\"synComment\"\u003e;環境と継続は保護\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003efirst-exp seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;そのまま次の命令を実行するのでnext\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003erest-exps seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;再帰的に命令列を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; lambda式\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; target(val)にコンパイルした式のラベルを束縛してlambda-linkageにジャンプ\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 実際に式を呼び出すときにcompile-lambda-bodyで作るラベルにジャンプし，処理をする\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eproc-entry \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eentry\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;コンパイルされた式はこのentry-idのラベルで処理される\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-lambda \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-lambda\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003elambda-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-lambda linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synComment\"\u003e;; tack-onでend-with-linkageにcompile-lambda-bodyを連結．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synComment\"\u003e;; neededとmodifiedはend-with-linkageのほうを使う\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etack-on-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         lambda-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop make-compiled-procedure\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e proc-entry\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       after-lambda\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; コンパイルした手続きが実際に処理をするラベルの中身を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-lambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e proc-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eformals \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elambda-parameters \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;lambdaの引数はformalsに束縛\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv proc argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synComment\"\u003e;; 実際の処理をするラベル\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e`(,\u003c/span\u003eproc-entry\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign env \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-env\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign env                     \u003cspan class=\"synComment\"\u003e;ここで仮引数と実引数で環境を拡張\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop extend-environment\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eformals\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg env\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synComment\"\u003e;; lambdaのbodyは式が複数のことがあるのでcompile-sequence\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synComment\"\u003e;; 呼び出し元に値を返さないと行けないのでlinkageはreturn\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-sequence \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elambda-body \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; apply\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-application \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; operatorをコンパイルしたら次はoperandの評価をしなければいけないのでnext\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eproc-code \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperator \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eproc \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; operandは複数なのでそれぞれcompileしてリストにして保持\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperand-codes\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003emap\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elambda\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperand\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile operand \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eoperands \u003cspan class=\"synIdentifier\"\u003eexp\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     proc-code                          \u003cspan class=\"synComment\"\u003e;最初にoperatorを確定させる\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstruct-arglist operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;operandを評価してarglに代入するための命令の生成\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-procedure-call target linkage\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; compile-applicationでoperand-codesはコンパイル済みなのでそれをarglに入れるための命令を生成\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econstruct-arglist operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synComment\"\u003e;; reverseして連結していくので右から左に評価することになる\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eoperand-codes \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ereverse\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; 引数がない場合はarglに'()を代入\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign argl \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003econst \u003cspan class=\"synSpecial\"\u003e()))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecode-to-get-last-arg     \u003cspan class=\"synComment\"\u003e;最後のoperandが生成する命令\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e         \u003cspan class=\"synComment\"\u003e;arglの初期化が必要なのでこれだけ特別に処理\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign argl \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop list\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              code-to-get-last-arg      \u003cspan class=\"synComment\"\u003e;cdrがnullなら最後のoperand\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synComment\"\u003e;; まだoperandが残っていればこちら\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e                   \u003cspan class=\"synComment\"\u003e;環境は保持\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               code-to-get-last-arg     \u003cspan class=\"synComment\"\u003e;引数の最後（reverseしているので先頭）からつなげる.\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; last-arg以外はここで処理する\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; operand-codesはコンパイル済み\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; arglには既に最後の引数が代入されているのでそこに先頭(reverseしてるので後ろ)から代入していく\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecode-for-next-arg              \u003cspan class=\"synComment\"\u003e;先頭\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e           \u003cspan class=\"synComment\"\u003e;valに先頭の要素のコンパイル結果を代入する命令\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eval argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eargl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e'((\u003c/span\u003eassign argl               \u003cspan class=\"synComment\"\u003e;valに入った(car operand)の値をarglに代入\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop cons\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-codes\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        code-for-next-arg\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eenv\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         code-for-next-arg\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecode-to-get-rest-args \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e operand-cods\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; operator, operandsを評価する命令を作った後に呼ばれる\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; この時点でprocにはoperatorのシンボル, arglにはoperandsが入っている\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-procedure-call target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eprimitive-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eprimitive-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompiled-branch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ecompiled-branch\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eafter-call \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eafter-call\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003ecompiled-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003enext\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e after-call linkage\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003etest \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop primitive-procedure?\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ebranch \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eprimitive-branch\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synComment\"\u003e;; compiled-branchかprimitive-branchのどちらかだけが実行されるのでparallel\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         compiled-branch\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synComment\"\u003e;; ここでtargetとlinkageに合わせた命令を生成\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-proc-appl target compiled-linkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         primitive-branch\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eend-with-linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          linkage\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc argl\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop apply-primitive-procedure\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg argl\u003cspan class=\"synSpecial\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e       after-call\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 手続きの採用\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ecompile-proc-appl target linkage\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synComment\"\u003e;; linkageがreturnでなければlinkageにはいったlabelが値を返す場所\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign continue \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;計算した値をvalに入れたらこのlinkageにジャンプ\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; targetがvalでないのでproc-returnでtargetにvalを代入しないといけない\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003eproc-return \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-label \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eproc-return\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e           \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign continue \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-return\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003eproc-return\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eassign \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003etarget \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;targetがvalでないので，ここでtargetにvalを代入\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elabel \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003elinkage\u003cspan class=\"synSpecial\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synComment\"\u003e;; targetがvalでreturnなら計算の後，continueに行けばいいので余計な処理はない\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e'(\u003c/span\u003eproc continue\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e all-regs\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e          \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003eassign val \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eop compiled-procedure-entry\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg proc\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003egoto \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003ereg val\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enot\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e target \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003eval\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eeq?\u003c/span\u003e linkage \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003ereturn\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e         \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eerror \u003cspan class=\"synConstant\"\u003e\"return linkage, target not val -- COMPILE\"\u003c/span\u003e target\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 命令列の組み合わせ\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'()\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecadr\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003esymbol?\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecaddr\u003c/span\u003e s\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eneeds-register? seq reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emodifies-register? seq reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; neededとmodifiedをうまく合成して新しい命令列を作る\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; これは人つながりの命令にする．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences \u003cspan class=\"synSpecial\"\u003e.\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-2-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synComment\"\u003e;; needed\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq1で変更してseq2がそれを必要とする\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                                  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;ならseq1の時点では必要ない\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e     \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eempty-instruction-sequence\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-2-sequences \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e  \u003cspan class=\"synComment\"\u003e;nullじゃなければこっち．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e seqs\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-seq-list seqs\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 集合演算\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union s1 s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference s1 s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003econd\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e'())\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ememq\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eelse\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003econs\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                    \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e s1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e s2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; regsの中にseq1で変更してseq2でしようするレジスタがあれば\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; seq1の前後でsave, restoreする命令を作る．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving regs seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003enull?\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eappend-instruction-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003elet\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e((\u003c/span\u003efirst-reg \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecar\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)))\u003c/span\u003e     \u003cspan class=\"synComment\"\u003e;first-regが\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e        \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003eand\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eneeds-register? seq2 first-reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq2に必要なレジスタで\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                 \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emodifies-register? seq1 first-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e \u003cspan class=\"synComment\"\u003e;seq1が変更するレジスタなら\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synComment\"\u003e;; needs ここでsaveするのでfirst-regが必要になるのでlist-union\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e first-reg\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                          \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synComment\"\u003e;; modify saveしてのseq2の前にrestoreするのでseq2から見ればfirst-reg変更無し\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-difference \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003elist\u003c/span\u003e first-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synComment\"\u003e;; statements 条件を満たすfirst-regの場合はseq1をsaveとrestoreで挟む\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e              \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003esave \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003efirst-reg\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e                      \u003cspan class=\"synSpecial\"\u003e`((\u003c/span\u003erestore \u003cspan class=\"synSpecial\"\u003e,\u003c/span\u003efirst-reg\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e             seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e            \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003epreserving \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecdr\u003c/span\u003e regs\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e seq1 seq2\u003cspan class=\"synSpecial\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; seqとbodyとbody-seqをつなげる．neededとmodifiedはseqのまま\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003etack-on-instruction-sequence seq body-seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements body-seq\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; neededとmodifiedは和集合を取る．\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; ifのconsequentとalternative, や\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synComment\"\u003e;;; 手続きのcompiled, primitiveの違いのようにどちらかだけが実行されるようなラベルを作るときに使う\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synStatement\"\u003edefine\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eparallel-instruction-sequences seq1 seq2\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003emake-instruction-sequence\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-needed seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003elist-union \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e               \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003eregisters-modified seq2\u003cspan class=\"synSpecial\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e   \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eappend\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq1\u003cspan class=\"synSpecial\"\u003e)\u003c/span\u003e \u003cspan class=\"synSpecial\"\u003e(\u003c/span\u003estatements seq2\u003cspan class=\"synSpecial\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"SICP 5.5.5 翻訳系"},"buildId":"vDqnfS-2Qy9jo2afqVhBT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>